<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿¡æ¯è¾“å…¥ - TOP_N æ¨å¹¿å¹³å°</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš€ TOP_N æ¨å¹¿å¹³å°</h1>
            <p class="subtitle">è®©æ‚¨çš„å…¬å¸åœ¨å¤§æ¨¡å‹æ¨èä¸­æ’åé å‰</p>
            <div class="header-buttons">
                <button class="btn-config" onclick="showAccountConfig()">âš™ï¸ è´¦å·é…ç½®</button>
                <button class="btn-login" id="login-btn" onclick="handleLoginClick()">ğŸ”‘ ç™»å½•/æ³¨å†Œ</button>
            </div>
        </header>

        <main>
            <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
            <div class="steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-title">è¾“å…¥ä¿¡æ¯</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-title">åˆ†æç”Ÿæˆ</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-title">å‘å¸ƒæ¨å¹¿</div>
                </div>
            </div>

            <!-- è¾“å…¥è¡¨å• -->
            <section id="input-section" class="section active">
                <h2>ğŸ“ è¾“å…¥å…¬å¸/äº§å“ä¿¡æ¯</h2>
                <form id="company-form">
                    <div class="form-group">
                        <label for="company-name">å…¬å¸/äº§å“åç§° *</label>
                        <input type="text" id="company-name" name="company_name" required
                               placeholder="ä¾‹å¦‚ï¼šXXXç§‘æŠ€æœ‰é™å…¬å¸">
                    </div>

                    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                    <div class="form-group">
                        <label>ğŸ“ ä¸Šä¼ æ–‡æ¡£ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="upload-area" id="upload-area">
                            <input type="file" id="file-upload" accept=".txt,.pdf,.doc,.docx,.md" style="display: none;">
                            <div class="upload-placeholder">
                                <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                                <p class="upload-hint">æ”¯æŒ TXT, PDF, DOC, DOCX, MD æ ¼å¼ï¼Œæœ€å¤§ 10MB</p>
                            </div>
                            <div class="upload-result" id="upload-result" style="display: none;">
                                <p>âœ… å·²ä¸Šä¼ : <span id="uploaded-filename"></span></p>
                                <button type="button" class="btn-small" onclick="clearUpload()">æ¸…é™¤</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="company-desc">è¯¦ç»†æè¿°</label>
                        <textarea id="company-desc" name="company_desc" rows="6"
                                  placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„å…¬å¸/äº§å“ï¼ŒåŒ…æ‹¬ä¸šåŠ¡é¢†åŸŸã€æ ¸å¿ƒä¼˜åŠ¿ã€ç›®æ ‡ç”¨æˆ·ç­‰ä¿¡æ¯...&#10;&#10;æç¤ºï¼šæ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ä¸Šä¼ æ–‡æ¡£æ¥æä¾›ä¿¡æ¯"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="article-count">ç”Ÿæˆæ–‡ç« æ•°é‡</label>
                        <select id="article-count" name="article_count">
                            <option value="3">3ç¯‡</option>
                            <option value="4">4ç¯‡</option>
                            <option value="5">5ç¯‡</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">å¼€å§‹åˆ†æ</button>
                </form>
            </section>

            <!-- åŠ è½½åŠ¨ç”» -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p id="loading-text">æ­£åœ¨å¤„ç†ä¸­...</p>
            </div>
        </main>

        <footer>
            <p>Â© 2024 TOP_N Platform - è®©æ‚¨çš„å“ç‰Œåœ¨AIæ—¶ä»£è„±é¢–è€Œå‡º</p>
        </footer>
    </div>

    <!-- è´¦å·é…ç½®æ¨¡æ€æ¡† -->
    <div id="account-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeAccountConfig()">&times;</span>
            <h2>âš™ï¸ æ¨å¹¿è´¦å·é…ç½®</h2>

            <!-- æ·»åŠ è´¦å·è¡¨å• -->
            <div class="account-form">
                <h3>æ·»åŠ æ–°è´¦å·</h3>
                <form id="add-account-form" onsubmit="addAccount(event)">
                    <div class="form-row">
                        <select id="acc-platform" required>
                            <option value="">é€‰æ‹©å¹³å°</option>
                            <option value="çŸ¥ä¹">çŸ¥ä¹ (Zhihu)</option>
                            <option value="CSDN">CSDN</option>
                            <option value="æ˜é‡‘">æ˜é‡‘ (Juejin)</option>
                            <option value="ç®€ä¹¦">ç®€ä¹¦ (Jianshu)</option>
                            <option value="ä»Šæ—¥å¤´æ¡">ä»Šæ—¥å¤´æ¡ (Toutiao)</option>
                            <option value="å¾®ä¿¡å…¬ä¼—å·">å¾®ä¿¡å…¬ä¼—å· (WeChat)</option>
                            <option value="åšå®¢å›­">åšå®¢å›­ (CNBlogs)</option>
                            <option value="å¼€æºä¸­å›½">å¼€æºä¸­å›½ (OSChina)</option>
                            <option value="segmentfault">SegmentFault</option>
                            <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰...</option>
                        </select>
                        <input type="text" id="acc-platform-custom" placeholder="è‡ªå®šä¹‰å¹³å°åç§°" style="display: none;">
                        <input type="text" id="acc-username" placeholder="ç”¨æˆ·å" required>
                    </div>
                    <div class="form-row">
                        <input type="password" id="acc-password" placeholder="å¯†ç " required>
                        <input type="text" id="acc-notes" placeholder="å¤‡æ³¨ (å¯é€‰)">
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ è´¦å·</button>
                </form>
            </div>

            <!-- æ‰¹é‡å¯¼å…¥ -->
            <div class="account-import">
                <h3>æ‰¹é‡å¯¼å…¥è´¦å·</h3>
                <div class="import-area">
                    <input type="file" id="account-file" accept=".json,.csv,.txt" style="display: none;" onchange="importAccounts(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('account-file').click()">
                        ğŸ“ é€‰æ‹©æ–‡ä»¶å¯¼å…¥
                    </button>
                    <p class="import-hint">æ”¯æŒ JSON, CSV, TXT æ ¼å¼</p>
                    <details>
                        <summary>æ–‡ä»¶æ ¼å¼è¯´æ˜</summary>
                        <div class="format-examples">
                            <p><strong>CSVæ ¼å¼:</strong> å¹³å°,ç”¨æˆ·å,å¯†ç ,å¤‡æ³¨</p>
                            <p><strong>TXTæ ¼å¼:</strong> å¹³å° ç”¨æˆ·å å¯†ç  å¤‡æ³¨ (ç©ºæ ¼åˆ†éš”)</p>
                            <p><strong>JSONæ ¼å¼:</strong> [{"platform":"çŸ¥ä¹","username":"user1","password":"pass1","notes":"å¤‡æ³¨"}]</p>
                        </div>
                    </details>
                </div>
            </div>

            <!-- è´¦å·åˆ—è¡¨ -->
            <div class="account-list">
                <h3>å·²é…ç½®è´¦å· <span id="account-count">(0)</span></h3>
                <div id="accounts-container"></div>
            </div>

            <!-- ç™»å½•æµ‹è¯•æç¤º -->
            <div id="test-result-modal" class="test-modal" style="display: none;">
                <div class="test-modal-content">
                    <span class="close" onclick="closeTestResult()">&times;</span>
                    <h3 id="test-result-title">ç™»å½•æµ‹è¯•</h3>
                    <div id="test-result-body"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/state.js"></script>
    <script src="/static/input.js"></script>
    <script src="/static/account_config.js"></script>
    <script>
        // ç™»å½•çŠ¶æ€ç®¡ç†
        let currentUser = null;

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();

                if (data.success && data.user) {
                    currentUser = data.user;
                    updateLoginButton(true);
                } else {
                    currentUser = null;
                    updateLoginButton(false);
                }
            } catch (error) {
                console.error('Failed to check login status:', error);
                updateLoginButton(false);
            }
        }

        // æ›´æ–°ç™»å½•æŒ‰é’®æ˜¾ç¤º
        function updateLoginButton(isLoggedIn) {
            const loginBtn = document.getElementById('login-btn');
            if (isLoggedIn && currentUser) {
                loginBtn.textContent = `ğŸ‘¤ ${currentUser.username}`;
                loginBtn.onclick = handleUserMenu;
            } else {
                loginBtn.textContent = 'ğŸ”‘ ç™»å½•/æ³¨å†Œ';
                loginBtn.onclick = handleLoginClick;
            }
        }

        // å¤„ç†ç™»å½•æŒ‰é’®ç‚¹å‡»
        function handleLoginClick() {
            window.location.href = '/login';
        }

        // å¤„ç†ç”¨æˆ·èœå•ç‚¹å‡»
        function handleUserMenu() {
            if (confirm(`å½“å‰ç”¨æˆ·: ${currentUser.username}\n\næ˜¯å¦é€€å‡ºç™»å½•?`)) {
                handleLogout();
            }
        }

        // å¤„ç†ç™»å‡º
        async function handleLogout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('å·²æˆåŠŸé€€å‡ºç™»å½•');
                    window.location.reload();
                } else {
                    alert('é€€å‡ºç™»å½•å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('é€€å‡ºç™»å½•å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
    </script>
</body>
</html>
