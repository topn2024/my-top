# 集中日志格式说明

## 概述

为了便于调试和问题追踪，已将分散的日志整合为**集中输出格式**。每个任务执行完成后，会统一打印一份完整的执行日志。

## 日志格式

### 完整日志示例（成功案例）

```
================================================================================
任务执行日志 - TaskID: abc-123-def-456
================================================================================
[23:45:01.234] [  0.00s] [INFO ] ============================================================
[23:45:01.235] [  0.00s] [INFO ] Worker开始执行任务
[23:45:01.236] [  0.00s] [INFO ] ============================================================

[23:45:01.237] [  0.01s] [INFO ] 【步骤1/5】获取任务信息
[23:45:01.238] [  0.01s] [INFO ] 获取任务信息 (DB_ID=28)
[23:45:01.289] [  0.05s] [INFO ] ✓ TaskID=abc-123-def-456, User=1, Platform=zhihu
[23:45:01.290] [  0.06s] [INFO ]   标题: 测试文章标题...
[23:45:01.291] [  0.06s] [INFO ]   内容长度: 500 字符

[23:45:01.292] [  0.06s] [INFO ] 【步骤2/5】更新任务状态
[23:45:01.293] [  0.06s] [INFO ] 更新任务状态: status=running, started_at=2025-12-10 23:45:01, progress=10
[23:45:01.345] [  0.11s] [INFO ] ✓ 状态更新成功

[23:45:01.346] [  0.11s] [INFO ] 【步骤3/5】获取平台账号
[23:45:01.347] [  0.11s] [INFO ] 获取知乎账号 (User=1)
[23:45:01.398] [  0.16s] [INFO ] ✓ 找到账号: admin
[23:45:01.399] [  0.17s] [INFO ] 更新任务状态: progress=20
[23:45:01.450] [  0.22s] [INFO ] ✓ 状态更新成功

[23:45:01.451] [  0.22s] [INFO ] 【步骤4/5】执行发布
[23:45:01.452] [  0.22s] [INFO ] 开始发布到知乎
[23:45:01.453] [  0.22s] [INFO ]   账号: admin
[23:45:01.454] [  0.22s] [INFO ]   标题: 测试文章标题...
[23:45:01.455] [  0.23s] [INFO ]   内容: 500 字符
[23:45:01.456] [  0.23s] [INFO ]   提供密码: 是
[23:45:09.876] [  8.64s] [INFO ] ✓ 知乎发布成功 (耗时 8.42秒)
[23:45:09.877] [  8.64s] [INFO ]   文章URL: https://zhuanlan.zhihu.com/p/123456
[23:45:09.878] [  8.65s] [INFO ] 更新任务状态: progress=90
[23:45:09.929] [  8.70s] [INFO ] ✓ 状态更新成功

[23:45:09.930] [  8.70s] [INFO ] 【步骤5/5】更新最终结果
[23:45:09.931] [  8.70s] [INFO ] 更新任务状态: status=success, result_url=https://..., progress=100
[23:45:09.982] [  8.75s] [INFO ] ✓ 状态更新成功

[23:45:09.983] [  8.75s] [INFO ] ✓✓✓ 任务执行成功！
[23:45:09.984] [  8.76s] [INFO ] 文章URL: https://zhuanlan.zhihu.com/p/123456

[23:45:09.985] [  8.76s] [INFO ] 释放限流令牌
[23:45:09.986] [  8.76s] [INFO ] ✓ 限流令牌已释放
================================================================================
总耗时: 8.76秒
================================================================================
```

### 完整日志示例（失败案例）

```
================================================================================
任务执行日志 - TaskID: xyz-789-abc-012
================================================================================
[23:50:01.100] [  0.00s] [INFO ] ============================================================
[23:50:01.101] [  0.00s] [INFO ] Worker开始执行任务
[23:50:01.102] [  0.00s] [INFO ] ============================================================

[23:50:01.103] [  0.01s] [INFO ] 【步骤1/5】获取任务信息
[23:50:01.104] [  0.01s] [INFO ] 获取任务信息 (DB_ID=29)
[23:50:01.155] [  0.06s] [INFO ] ✓ TaskID=xyz-789-abc-012, User=1, Platform=zhihu
[23:50:01.156] [  0.06s] [INFO ]   标题: 另一篇测试文章...
[23:50:01.157] [  0.06s] [INFO ]   内容长度: 300 字符

[23:50:01.158] [  0.06s] [INFO ] 【步骤2/5】更新任务状态
[23:50:01.159] [  0.06s] [INFO ] 更新任务状态: status=running, started_at=2025-12-10 23:50:01, progress=10
[23:50:01.210] [  0.11s] [INFO ] ✓ 状态更新成功

[23:50:01.211] [  0.11s] [INFO ] 【步骤3/5】获取平台账号
[23:50:01.212] [  0.11s] [INFO ] 获取知乎账号 (User=1)
[23:50:01.263] [  0.16s] [WARN ] 未找到账号，使用默认
[23:50:01.264] [  0.17s] [INFO ] 更新任务状态: progress=20
[23:50:01.315] [  0.22s] [INFO ] ✓ 状态更新成功

[23:50:01.316] [  0.22s] [INFO ] 【步骤4/5】执行发布
[23:50:01.317] [  0.22s] [INFO ] 开始发布到知乎
[23:50:01.318] [  0.22s] [INFO ]   账号: user_1
[23:50:01.319] [  0.23s] [INFO ]   标题: 另一篇测试文章...
[23:50:01.320] [  0.23s] [INFO ]   内容: 300 字符
[23:50:01.321] [  0.23s] [INFO ]   提供密码: 否
[23:50:06.543] [  5.44s] [ERROR] ✗ 知乎发布失败: Cookie登录失败，且未提供密码

[23:50:06.544] [  5.44s] [ERROR] ✗✗✗ 任务执行失败
[23:50:06.545] [  5.45s] [ERROR] 异常类型: Exception
[23:50:06.546] [  5.45s] [ERROR] 异常信息: Cookie登录失败，且未提供密码
[23:50:06.547] [  5.45s] [INFO ] 更新任务状态: status=failed
[23:50:06.598] [  5.50s] [INFO ] ✓ 状态更新成功

[23:50:06.599] [  5.50s] [INFO ] 释放限流令牌
[23:50:06.600] [  5.50s] [INFO ] ✓ 限流令牌已释放
================================================================================
总耗时: 5.50秒
================================================================================
```

### MySQL连接重试示例

```
================================================================================
任务执行日志 - TaskID: retry-test-001
================================================================================
[23:52:01.100] [  0.00s] [INFO ] ============================================================
[23:52:01.101] [  0.00s] [INFO ] Worker开始执行任务
[23:52:01.102] [  0.00s] [INFO ] ============================================================

[23:52:01.103] [  0.01s] [INFO ] 【步骤1/5】获取任务信息
[23:52:01.104] [  0.01s] [INFO ] 获取任务信息 (DB_ID=30)
[23:52:01.155] [  0.06s] [INFO ] ✓ TaskID=retry-test-001, User=1, Platform=zhihu

... (中间省略) ...

[23:52:10.500] [  9.40s] [INFO ] 【步骤5/5】更新最终结果
[23:52:10.501] [  9.40s] [INFO ] 更新任务状态: status=success, result_url=https://...
[23:52:10.502] [  9.41s] [WARN ] 数据库连接失败，1秒后重试 (尝试 1/3)
[23:52:11.503] [ 10.41s] [INFO ] ✓ 状态更新成功
[23:52:11.504] [ 10.41s] [INFO ] ✓✓✓ 任务执行成功！

[23:52:11.505] [ 10.41s] [INFO ] 释放限流令牌
[23:52:11.506] [ 10.42s] [INFO ] ✓ 限流令牌已释放
================================================================================
总耗时: 10.42秒
================================================================================
```

## 日志字段说明

### 时间戳格式

```
[23:45:01.234]  - 绝对时间（时:分:秒.毫秒）
[  8.76s]       - 相对时间（从任务开始的秒数）
```

### 日志级别

- `[INFO ]` - 正常信息
- `[WARN ]` - 警告信息（可能有问题但不影响继续）
- `[ERROR]` - 错误信息（导致失败）
- `[DEBUG]` - 调试信息（详细的技术细节）

### 关键标识符

- `✓` - 操作成功
- `✗` - 操作失败
- `【步骤X/5】` - 执行阶段标识

## 五个执行阶段

### 步骤1: 获取任务信息
```
【步骤1/5】获取任务信息
获取任务信息 (DB_ID=28)
✓ TaskID=..., User=..., Platform=...
  标题: ...
  内容长度: ... 字符
```

### 步骤2: 更新任务状态
```
【步骤2/5】更新任务状态
更新任务状态: status=running, ...
✓ 状态更新成功
```

### 步骤3: 获取平台账号
```
【步骤3/5】获取平台账号
获取知乎账号 (User=1)
✓ 找到账号: admin
或
⚠ 未找到账号，使用默认
```

### 步骤4: 执行发布
```
【步骤4/5】执行发布
开始发布到知乎
  账号: admin
  标题: ...
  内容: ... 字符
  提供密码: 是/否
✓ 知乎发布成功 (耗时 X.XX秒)
  文章URL: https://...
或
✗ 知乎发布失败: 错误原因
```

### 步骤5: 更新最终结果
```
【步骤5/5】更新最终结果
更新任务状态: status=success/failed, ...
✓ 状态更新成功
✓✓✓ 任务执行成功！
或
✗✗✗ 任务执行失败
```

## 日志优势

### 1. 集中输出
- ✅ 一个任务的所有日志在一起
- ✅ 便于复制粘贴整段日志
- ✅ 清晰的开始和结束分隔符

### 2. 时间追踪
- ✅ 绝对时间：知道何时执行
- ✅ 相对时间：知道每步耗时
- ✅ 总耗时：一目了然

### 3. 问题定位
- ✅ 分阶段标识：快速定位失败环节
- ✅ 详细错误信息：包含异常类型和消息
- ✅ 重试信息：显示重试次数和结果

### 4. 可读性强
- ✅ 清晰的缩进和分组
- ✅ 统一的符号标识（✓ ✗）
- ✅ 重要信息突出显示

## 查看日志

### 实时监控

```bash
# 查看Worker-1的实时日志
ssh u_topn@39.105.12.124 "tail -f /home/u_topn/TOP_N/logs/worker-1.log"

# 查看所有Worker的实时日志
ssh u_topn@39.105.12.124 "tail -f /home/u_topn/TOP_N/logs/worker-*.log"
```

### 搜索特定任务

```bash
# 根据TaskID搜索
ssh u_topn@39.105.12.124 "grep -A 50 'TaskID: abc-123' /home/u_topn/TOP_N/logs/worker-*.log"

# 查看所有失败任务
ssh u_topn@39.105.12.124 "grep -A 50 '✗✗✗ 任务执行失败' /home/u_topn/TOP_N/logs/worker-*.log"

# 查看所有成功任务
ssh u_topn@39.105.12.124 "grep -A 5 '✓✓✓ 任务执行成功' /home/u_topn/TOP_N/logs/worker-*.log"
```

### 分析执行时间

```bash
# 查看耗时超过10秒的任务
ssh u_topn@39.105.12.124 "grep '总耗时:' /home/u_topn/TOP_N/logs/worker-*.log | awk -F: '{if (\$NF > 10) print}'"

# 查看平均耗时
ssh u_topn@39.105.12.124 "grep '总耗时:' /home/u_topn/TOP_N/logs/worker-*.log | awk '{sum+=\$2; count++} END {print \"平均:\", sum/count, \"秒\"}'"
```

## 日志级别控制

### 当前设置
- 生产环境：`DEBUG`（便于问题排查）
- 可以看到所有详细信息

### 如需调整为INFO

修改 `/home/u_topn/TOP_N/backend/config.py`:
```python
class ProductionConfig(Config):
    LOG_LEVEL = 'INFO'  # 改为INFO
```

然后重启服务：
```bash
ssh u_topn@39.105.12.124 "bash /home/u_topn/TOP_N/backend/start_workers.sh"
```

## 对比旧版日志

### 旧版（分散）
```
15:43:42 user:1: backend.services.publish_worker.execute_publish_task...
[发布流程-Worker] ========== Worker开始执行任务 ==========
[发布流程-Worker] 任务DB ID: 16
[发布流程-Worker] 从数据库获取任务信息
[发布流程-Worker] 任务信息: TaskID=...
... (散落在多行日志中)
Cookie登录失败或Cookie不存在
任务执行失败: (pymysql.err.OperationalError)...
15:44:00 Successfully completed ... job in 0:00:18s
```
❌ 问题：
- 分散在不同行
- 难以区分哪些属于同一任务
- 缺少整体视图
- 难以复制完整日志

### 新版（集中）
```
================================================================================
任务执行日志 - TaskID: abc-123
================================================================================
[23:45:01.234] [  0.00s] [INFO ] 【步骤1/5】获取任务信息
[23:45:01.289] [  0.05s] [INFO ] ✓ TaskID=abc-123...
... (所有日志集中在一起)
[23:45:09.983] [  8.75s] [INFO ] ✓✓✓ 任务执行成功！
================================================================================
总耗时: 8.76秒
================================================================================
```
✅ 优势：
- 集中在一个区块
- 清晰的边界分隔
- 完整的执行视图
- 便于复制和分析

## 总结

### 主要改进

1. **集中输出** - 一个任务一个完整日志块
2. **时间追踪** - 绝对+相对时间双重显示
3. **阶段清晰** - 5个步骤明确标识
4. **符号标识** - ✓ ✗ 一目了然
5. **便于调试** - 快速定位问题环节

### 使用建议

- 开发/测试阶段：使用DEBUG级别
- 生产稳定后：可改为INFO级别
- 出现问题时：查看完整日志块
- 性能分析：关注总耗时和各步骤耗时

---

**版本**: Worker V3 (集中日志版)
**部署时间**: 2025-12-10 23:38
**部署状态**: ✅ 已部署到生产环境
