<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>调试发布历史</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-box { border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: #f5f5f5; }
        .error { color: red; }
        .success { color: green; }
        pre { background: #fff; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>发布历史API调试</h1>

    <div id="status"></div>

    <div class="debug-box">
        <h3>步骤1: 登录</h3>
        <input type="text" id="username" placeholder="用户名" value="lijingjing" style="padding: 5px; margin-right: 10px;">
        <input type="password" id="password" placeholder="密码" style="padding: 5px; margin-right: 10px;">
        <button onclick="doLogin()">登录</button>
        <div id="login-result"></div>
    </div>

    <div class="debug-box">
        <h3>步骤2: 获取发布历史</h3>
        <button onclick="getHistory()">获取历史</button>
        <div id="history-result"></div>
    </div>

    <div class="debug-box">
        <h3>原始响应</h3>
        <pre id="raw-response"></pre>
    </div>

    <div class="debug-box">
        <h3>解析后的数据</h3>
        <pre id="parsed-data"></pre>
    </div>

    <div class="debug-box">
        <h3>显示测试</h3>
        <table border="1" cellpadding="5">
            <thead>
                <tr>
                    <th>文章标题</th>
                    <th>平台</th>
                    <th>状态</th>
                </tr>
            </thead>
            <tbody id="test-table"></tbody>
        </table>
    </div>

    <script>
        async function doLogin() {
            const resultDiv = document.getElementById('login-result');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            resultDiv.innerHTML = '登录中...';

            try {
                const response = await fetch('http://39.105.12.124/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();
                resultDiv.innerHTML = `<span class="success">✓ 登录成功</span><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ 登录失败: ${error.message}</span>`;
            }
        }

        async function getHistory() {
            const resultDiv = document.getElementById('history-result');
            const rawDiv = document.getElementById('raw-response');
            const parsedDiv = document.getElementById('parsed-data');
            const tableBody = document.getElementById('test-table');

            resultDiv.innerHTML = '获取中...';

            try {
                const response = await fetch('http://39.105.12.124/api/publish_history', {
                    credentials: 'include'
                });

                // 获取原始文本
                const rawText = await response.text();
                rawDiv.textContent = rawText;

                // 检查Unicode转义
                const hasUnicodeEscape = /\\u[0-9a-fA-F]{4}/.test(rawText);

                if (hasUnicodeEscape) {
                    resultDiv.innerHTML = '<span class="error">✗ 发现Unicode转义序列</span>';
                } else {
                    resultDiv.innerHTML = '<span class="success">✓ 没有Unicode转义</span>';
                }

                // 解析JSON
                const data = JSON.parse(rawText);
                parsedDiv.textContent = JSON.stringify(data, null, 2);

                // 显示在表格中
                if (data.success && data.history) {
                    tableBody.innerHTML = '';
                    data.history.forEach(item => {
                        const row = tableBody.insertRow();

                        const titleCell = row.insertCell(0);
                        titleCell.textContent = item.article_title || '(空)';
                        titleCell.style.maxWidth = '300px';
                        titleCell.style.wordBreak = 'break-all';

                        const platformCell = row.insertCell(1);
                        platformCell.textContent = item.platform || 'N/A';

                        const statusCell = row.insertCell(2);
                        statusCell.textContent = item.status || 'N/A';
                    });

                    resultDiv.innerHTML += `<br><span class="success">✓ 成功获取 ${data.count} 条记录</span>`;
                } else {
                    resultDiv.innerHTML += `<br><span class="error">✗ 数据格式异常</span>`;
                }

            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ 请求失败: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
