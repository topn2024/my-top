# 数据库完整性检查报告

**检查时间:** 2025-12-15 19:16:09
**检查服务器:** 39.105.12.124
**数据库:** topn.db

---

## 📊 总体概况

### 数据库表统计

数据库共有 **15 个表**，其中：
- ✅ **有数据的表**: 9 个
- ○ **空表**: 6 个

| 表名 | 记录数 | 状态 |
|------|--------|------|
| users | 4 | ✅ |
| workflows | 13 | ✅ |
| articles | 3 | ✅ |
| platform_accounts | 3 | ✅ |
| publish_history | 29 | ✅ |
| publish_tasks | 6 | ✅ |
| prompt_templates | 4 | ✅ |
| prompt_template_categories | 14 | ✅ |
| prompt_template_audit_logs | 8 | ✅ |
| prompt_example_library | 2 | ✅ |
| analysis_prompts | 0 | ○ |
| article_prompts | 0 | ○ |
| platform_style_prompts | 0 | ○ |
| prompt_combination_logs | 0 | ○ |
| prompt_template_usage_logs | 0 | ○ |

---

## 👥 用户表 (users) - ✅ 完整

**总用户数:** 4

### 用户详情

| ID | 用户名 | 角色 | 工作流 | 文章 | 发布历史 | 平台账号 | 创建时间 |
|----|--------|------|--------|------|----------|----------|----------|
| 1 | admin | admin | 13 | 3 | 29 | 3 | 2025-12-11 09:02:33 |
| 2 | lijingjing | user | 0 | 0 | 0 | 0 | 2025-12-11 09:34:53 |
| 3 | testuser | user | 0 | 0 | 0 | 0 | 2025-12-13 16:55:15 |
| 4 | normaluser | user | 0 | 0 | 0 | 0 | 2025-12-13 16:56:44 |

**结论:**
- ✅ 所有用户都有完整的必填字段（username, password_hash, email）
- ✅ 主要活动集中在 admin 用户
- ✅ 其他3个用户为测试用户，暂无活动数据

---

## 📝 文章表 (articles) - ✅ 完整

**总文章数:** 3

### 文章详情

| ID | 标题 | 所属用户 | 工作流 | 类型 | 内容长度 | 发布历史 | 创建时间 |
|----|------|----------|--------|------|----------|----------|----------|
| 1 | 月栖科技：引领AI智能体新纪元，共创智慧未来 | admin | 11 | 技术创新 | 915 | 0 | 2025-12-15 09:58:27 |
| 2 | 月栖科技：AI智能体引领未来，打造行业解决方案新标杆 | admin | 11 | 行业应用 | 784 | 0 | 2025-12-15 09:58:27 |
| 3 | 月栖科技：AI智能体研发新高度，助力企业跃升未来 | admin | 11 | 用户价值 | 806 | 0 | 2025-12-15 09:58:27 |

**结论:**
- ✅ 所有文章都有完整的标题和内容
- ✅ 所有文章都正确关联到工作流
- ⚠️ 这3篇文章都在 articles 表中，但没有对应的 publish_history 记录
- 说明：这些是最近创建的文章，尚未发布

---

## 📤 发布历史表 (publish_history) - ⚠️ 部分缺失

**总记录数:** 29

### 数据完整性

| 指标 | 数量 | 百分比 |
|------|------|--------|
| 有标题的记录 | 29 | 100% |
| 有内容的记录 | 16 | 55% |
| **缺少内容的记录** | **13** | **45%** |

### 平台分布

| 平台 | 记录数 |
|------|--------|
| zhihu | 15 |
| 知乎 | 14 |

**注意:** "zhihu" 和 "知乎" 应该统一为同一平台标识

### 状态分布

| 状态 | 记录数 |
|------|--------|
| failed | 21 |
| success | 8 |

### 缺少内容的记录示例

| ID | 标题 | 平台 | 状态 | URL |
|----|------|------|------|-----|
| 1 | 历史发布记录 | 知乎 | success | https://zhuanlan.zhihu.com/p/1980752525129954925/edit |
| 2 | 历史发布记录 | 知乎 | failed | 无 |
| 3 | 历史发布记录 | 知乎 | failed | 无 |
| 4 | 历史发布记录 | 知乎 | success | https://zhuanlan.zhihu.com/p/1980760405010838789/edit |
| 5 | 历史发布记录 | 知乎 | failed | 无 |

### 与 publish_tasks 的一致性

- publish_tasks 成功任务: 0 条
- publish_tasks 失败任务: 6 条
- ✅ 所有成功任务都已记录在 publish_history 中

**结论:**
- ⚠️ **主要问题**: 13 条记录缺少 `article_content` 字段
- ✅ 所有记录都有标题
- ⚠️ 平台标识不统一（"zhihu" vs "知乎"）
- ✅ 与 publish_tasks 表的一致性良好

---

## 🔄 发布任务表 (publish_tasks) - ✅ 完整

**总任务数:** 6

### 状态分布

| 状态 | 数量 |
|------|------|
| failed | 6 |

### 平台分布

| 平台 | 数量 |
|------|------|
| zhihu | 6 |

### 数据完整性

- ✅ 有完整数据 (标题+内容): 6 条
- ○ 数据不完整: 0 条

### 任务详情示例

| ID | 标题 | 状态 | 平台 | URL | 内容长度 |
|----|------|------|------|-----|----------|
| 1 | 揭秘月栖科技：AI智能体的黑科技，竟然这么牛？ | failed | zhihu | https://zhuanlan.zhihu.com/p/1982498178818410358/edit | 1223 |
| 2 | 揭秘月栖科技：AI智能体领域的"黑马"，技术实力不容小觑 | failed | zhihu | 无 | 1141 |
| 3 | 月栖科技：引领AI智能体新纪元，共创智慧未来 | failed | zhihu | 无 | 915 |

**结论:**
- ✅ 所有任务都有完整的标题和内容数据
- ⚠️ 所有任务状态都是 "failed"
- ℹ️ 即使标记为 "failed"，部分任务也生成了 URL（说明文章已创建，但发布流程中某个环节失败）

---

## 🔑 平台账号表 (platform_accounts) - ✅ 完整

**总账号数:** 3

### 账号详情

| ID | 用户名 | 平台 | 所属用户 | 状态 | 创建时间 | 最后测试 |
|----|--------|------|----------|------|----------|----------|
| 1 | admin | zhihu | admin | active | 2025-12-11 09:02:33 | - |
| 2 | test | 掘金 | admin | failed | 2025-12-14 16:25:55 | 2025-12-15 00:35:21 |
| 3 | test | CSDN | admin | active | 2025-12-14 16:36:16 | - |

### 平台分布

| 平台 | 账号数 |
|------|--------|
| CSDN | 1 |
| zhihu | 1 |
| 掘金 | 1 |

**结论:**
- ✅ 所有账号都有完整的必填字段
- ✅ 所有账号都正确关联到用户
- ⚠️ 掘金账号状态为 "failed"（已于 2025-12-15 测试失败）
- ✅ 其他两个账号状态正常

---

## 🔄 工作流表 (workflows) - ✅ 完整

**总工作流数:** 13

### 状态分布

| 状态 | 数量 |
|------|------|
| in_progress | 13 |

### 工作流详情

- 所有 13 个工作流都属于 admin 用户
- 所有工作流状态都是 "in_progress"

**结论:**
- ✅ 所有工作流都正确关联到用户
- ⚠️ 所有工作流都处于 "in_progress" 状态
- 建议：检查是否有需要标记为 "completed" 的工作流

---

## 🎨 提示词模板系统 - ✅ 基本完整

### 各表记录数

| 表名 | 记录数 |
|------|--------|
| prompt_templates | 4 |
| prompt_template_categories | 14 |
| prompt_template_audit_logs | 8 |
| prompt_example_library | 2 |
| prompt_template_usage_logs | 0 |

**结论:**
- ✅ 提示词模板系统已初始化
- ✅ 有 4 个提示词模板
- ✅ 有 14 个分类
- ✅ 有 8 条审计日志
- ○ 暂无使用日志（新功能，正常）

---

## 🚨 主要问题汇总

### 1. publish_history 表缺少内容数据 ⚠️

**问题描述:**
- 29 条发布历史记录中，有 13 条（45%）缺少 `article_content` 字段

**影响:**
- 前端发布历史页面的"查看内容"按钮无法显示完整内容
- 重试发布功能可能无法获取内容

**原因分析:**
- 这些记录标题为"历史发布记录"，推测是早期测试数据
- 部分记录没有关联 `article_id`
- 无法从 `publish_tasks` 表补充（因为没有成功的任务记录可以匹配）

**建议解决方案:**
1. **短期方案**: 这些记录大多是早期测试数据，可以考虑清理
2. **长期方案**:
   - 修改发布流程，确保新记录总是包含 `article_content`
   - 实施了数据迁移脚本（已完成），但无可用数据源进行补充

### 2. 平台标识不统一 ⚠️

**问题描述:**
- publish_history 表中同时存在 "zhihu" 和 "知乎" 两种平台标识

**影响:**
- 数据统计可能不准确
- 平台筛选功能可能混乱

**建议解决方案:**
```sql
-- 统一为英文标识
UPDATE publish_history SET platform = 'zhihu' WHERE platform = '知乎';
```

### 3. 工作流状态未更新 ⚠️

**问题描述:**
- 所有 13 个工作流都处于 "in_progress" 状态

**影响:**
- 无法区分正在进行的工作流和已完成的工作流

**建议解决方案:**
- 检查工作流是否实际完成
- 将已完成的工作流标记为 "completed"

---

## ✅ 数据一致性检查结果

### 外键关联检查

| 表 | 外键字段 | 关联表 | 状态 |
|----|----------|--------|------|
| articles | workflow_id | workflows | ✅ 完整 |
| platform_accounts | user_id | users | ✅ 完整 |
| publish_history | user_id | users | ✅ 完整 |
| publish_history | article_id | articles | ⚠️ 大部分为 NULL |
| publish_tasks | user_id | users | ✅ 完整 |
| publish_tasks | article_id | articles | ⚠️ 部分为 NULL |
| workflows | user_id | users | ✅ 完整 |

**结论:**
- ✅ 核心外键关联完整，没有孤立记录
- ⚠️ publish_history 和 publish_tasks 的 article_id 经常为 NULL（临时发布场景）

---

## 📋 建议的修复措施

### 优先级1：数据清理

```sql
-- 1. 统一平台标识
UPDATE publish_history SET platform = 'zhihu' WHERE platform = '知乎';

-- 2. 清理早期测试数据（可选）
DELETE FROM publish_history
WHERE article_title = '历史发布记录'
  AND (article_content IS NULL OR article_content = '');
```

### 优先级2：工作流状态更新

```python
# 检查并更新已完成的工作流状态
# 需要根据业务逻辑判断哪些工作流应该标记为 completed
```

### 优先级3：代码改进

1. **发布流程改进** (`backend/services/publish_worker.py`)
   - 确保新的发布记录总是保存 `article_content`

2. **平台标识规范化**
   - 前后端统一使用英文标识（如 "zhihu" 而非 "知乎"）

---

## 📊 数据健康度评分

| 维度 | 评分 | 说明 |
|------|------|------|
| **数据完整性** | 85/100 | 大部分数据完整，publish_history 有部分缺失 |
| **关联完整性** | 95/100 | 外键关联完整，无孤立记录 |
| **数据一致性** | 80/100 | 平台标识不统一 |
| **总体健康度** | **87/100** | **良好** |

---

## 🎯 总结

### 优点
- ✅ 核心业务数据（用户、文章、平台账号）完整性良好
- ✅ 外键关联正确，无孤立记录
- ✅ 提示词模板系统已初始化
- ✅ 数据量合理，无异常增长

### 需要改进
- ⚠️ 45% 的发布历史记录缺少内容数据
- ⚠️ 平台标识不统一（中英文混用）
- ⚠️ 工作流状态需要更新

### 下一步行动
1. 执行优先级1的数据清理（统一平台标识）
2. 评估是否清理早期测试数据
3. 修改发布流程代码，确保新记录完整性
4. 定期执行数据完整性检查（建议每周一次）

---

**报告生成时间:** 2025-12-15
**检查工具:** `check_data_integrity.py`
**数据库备份:** `topn.db.backup_20251215_190254` (428KB)
