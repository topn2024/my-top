# OpenAI API 错误修复说明

## 问题描述
服务器报错：`module 'openai' has no attribute 'ChatCompletion'`

## 根本原因
`backend/app_with_upload.py` 使用了旧版 OpenAI API 语法，但服务器上安装的是新版 openai 库（>=1.0.0）。

### 旧版语法 (已弃用)
```python
# 旧版配置方式
openai.api_key = 'xxx'
openai.api_base = 'xxx'

# 旧版调用方式
response = openai.ChatCompletion.create(...)
analysis = response.choices[0].message['content']
```

### 新版语法 (正确)
```python
# 新版配置方式
client = openai.OpenAI(
    api_key="xxx",
    base_url="xxx"
)

# 新版调用方式
response = client.chat.completions.create(...)
analysis = response.choices[0].message.content
```

## 修复内容

### 1. 修改 backend/app_with_upload.py

#### 第 37-39 行：更新配置方式
```python
# 千问API配置
QIANWEN_API_KEY = "sk-f0a85d3e56a746509ec435af2446c67a"
QIANWEN_BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1"

# 初始化OpenAI客户端（兼容千问API）
client = openai.OpenAI(
    api_key=QIANWEN_API_KEY,
    base_url=QIANWEN_BASE_URL
)
```

#### 第 195-204 行：更新 analyze_company 函数
```python
response = client.chat.completions.create(
    model='qwen-plus',
    messages=[
        {'role': 'system', 'content': '你是一个专业的商业分析师，擅长分析公司和产品信息。'},
        {'role': 'user', 'content': prompt}
    ],
    temperature=0.7
)

analysis = response.choices[0].message.content
```

#### 第 257-266 行：更新 generate_articles 函数
```python
response = client.chat.completions.create(
    model='qwen-plus',
    messages=[
        {'role': 'system', 'content': '你是一个专业的科技文章撰写者。'},
        {'role': 'user', 'content': prompt}
    ],
    temperature=0.8
)

article_text = response.choices[0].message.content
```

### 2. 更新 requirements.txt
```
flask==3.0.0
flask-cors==4.0.0
openai>=1.0.0
requests==2.31.0
gunicorn==21.2.0
PyPDF2>=3.0.0
python-docx>=0.8.11
```

## 部署步骤

### 方法1：使用部署脚本（推荐）
```bash
# 在本地执行
./deploy.sh
```

部署脚本会自动：
1. 上传修复后的文件到服务器
2. 重新安装依赖
3. 重启服务

### 方法2：手动部署
```bash
# 1. 上传修复后的文件
scp backend/app_with_upload.py u_topn@39.105.12.124:/home/u_topn/TOP_N/backend/
scp requirements.txt u_topn@39.105.12.124:/home/u_topn/TOP_N/

# 2. 登录服务器
ssh u_topn@39.105.12.124

# 3. 重新安装依赖
cd /home/u_topn/TOP_N
source venv/bin/activate
pip install -r requirements.txt --upgrade

# 4. 重启服务
sudo systemctl restart topn

# 5. 查看服务状态
sudo systemctl status topn

# 6. 查看日志（确认没有错误）
sudo journalctl -u topn -f
```

## 验证修复

### 1. 检查服务状态
```bash
ssh u_topn@39.105.12.124 'sudo systemctl status topn'
```

应该看到 `Active: active (running)`

### 2. 查看日志
```bash
ssh u_topn@39.105.12.124 'sudo journalctl -u topn -n 50 --no-pager'
```

不应该再看到 `module 'openai' has no attribute 'ChatCompletion'` 错误

### 3. 测试API
访问：http://39.105.12.124:8080

测试功能：
- 文件上传
- 公司分析
- 文章生成

## 相关文件

- **修复的代码**: `backend/app_with_upload.py`
- **依赖配置**: `requirements.txt`
- **部署脚本**: `deploy.sh`
- **服务配置**: `/etc/systemd/system/topn.service` (服务器上)

## 注意事项

1. **API兼容性**: 新版 openai 库（>=1.0.0）不再支持旧语法
2. **千问API**: 代码使用千问的兼容 OpenAI API，需要正确的 API key 和 base URL
3. **文档处理**: 确保服务器上安装了 PyPDF2 和 python-docx 库以支持文件上传功能

## 问题排查

如果部署后仍有问题：

```bash
# 查看完整错误日志
sudo journalctl -u topn -p err --no-pager

# 检查 Python 包版本
source /home/u_topn/TOP_N/venv/bin/activate
pip list | grep openai

# 手动测试代码
cd /home/u_topn/TOP_N/backend
python3 -c "import openai; client = openai.OpenAI(api_key='test'); print('OK')"
```

## 修复时间
2025-12-05

## 修复状态
✅ 已完成
