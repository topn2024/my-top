# 真实网站登录测试功能 - 使用说明

## 功能概述

已实现真实网站登录测试功能，通过 Selenium WebDriver 自动化测试框架，可以真正地登录到各个推广平台网站，验证账号有效性。

## 当前状态

### 已部署功能
1. **账号配置界面** ✅
   - 平台下拉选择（9个常用平台 + 自定义）
   - 账号添加/删除
   - 批量导入（CSV/TXT/JSON）

2. **登录测试框架** ✅
   - 后端API：`POST /api/accounts/<id>/test`
   - 登录测试模块：`backend/login_tester.py`
   - 自动降级机制：Selenium不可用时使用基础验证

3. **支持的登录方式**
   - **知乎**: 完整实现，支持密码登录
   - **CSDN**: 完整实现，支持密码登录
   - **其他平台**: 待开发

### Selenium 环境要求

服务器需要安装以下组件才能使用真实登录测试：

1. **Google Chrome 浏览器**
2. **ChromeDriver**（版本需匹配Chrome版本）
3. **Python Selenium 库**

## 安装 Selenium 环境

### 方式一：使用自动安装脚本

```bash
# 在本地运行
cd D:\work\code\TOP_N
python install_selenium_server.py
```

### 方式二：手动安装（在服务器上执行）

```bash
# SSH连接到服务器
ssh u_topn@39.105.12.124

# 1. 安装Chrome
sudo yum install -y wget unzip
cd /tmp
wget https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm
sudo yum install -y /tmp/google-chrome-stable_current_x86_64.rpm

# 2. 安装ChromeDriver
# 查看Chrome版本
google-chrome --version

# 下载对应版本的ChromeDriver（示例使用114版本）
wget https://chromedriver.storage.googleapis.com/114.0.5735.90/chromedriver_linux64.zip
unzip chromedriver_linux64.zip
sudo mv chromedriver /usr/local/bin/
sudo chmod +x /usr/local/bin/chromedriver

# 3. 安装Python Selenium库
/home/u_topn/TOP_N/venv/bin/pip install selenium

# 4. 验证安装
google-chrome --version
chromedriver --version
/home/u_topn/TOP_N/venv/bin/python -c "import selenium; print(selenium.__version__)"
```

## 登录测试流程

### 知乎登录测试
1. 访问知乎登录页 https://www.zhihu.com/signin
2. 切换到密码登录
3. 输入用户名和密码
4. 提交登录表单
5. 检测登录结果：
   - 成功：跳转到首页，检测到用户信息元素
   - 失败：停留在登录页或显示错误信息
   - 需要验证码：提示用户手动验证

### CSDN登录测试
1. 访问CSDN登录页 https://passport.csdn.net/login
2. 切换到密码登录
3. 输入用户名和密码
4. 提交登录表单
5. 检测登录结果

## 当前限制

1. **验证码问题**：
   - 如果平台要求验证码，自动登录会失败
   - 建议：使用已经在该IP登录过的账号，减少验证码出现

2. **无头模式**：
   - 服务器环境使用无头模式（headless）
   - 某些平台可能检测无头浏览器

3. **平台覆盖**：
   - 目前仅实现知乎和CSDN
   - 其他平台返回"暂不支持"提示

## 扩展新平台

要添加新平台的登录测试，在 `backend/login_tester.py` 中：

```python
def test_新平台_login(self, username, password):
    """测试新平台登录"""
    try:
        logger.info(f"Testing 新平台 login for user: {username}")

        # 1. 访问登录页
        self.driver.get('https://新平台.com/login')
        time.sleep(2)

        # 2. 找到并填写表单元素
        username_input = WebDriverWait(self.driver, 10).until(
            EC.presence_of_element_located((By.ID, "username"))  # 根据实际页面调整
        )
        username_input.send_keys(username)

        password_input = self.driver.find_element(By.ID, "password")
        password_input.send_keys(password)

        # 3. 提交登录
        login_button = self.driver.find_element(By.ID, "login-btn")
        login_button.click()
        time.sleep(3)

        # 4. 检测登录结果
        current_url = self.driver.current_url
        if 'login' not in current_url:
            return {
                'success': True,
                'message': '新平台登录成功！',
                'current_url': current_url
            }

        return {'success': False, 'message': '登录失败'}

    except Exception as e:
        logger.error(f"新平台 login test failed: {e}", exc_info=True)
        return {'success': False, 'message': f'登录测试异常: {str(e)}'}
```

然后在 `test_login` 方法中添加调用：

```python
def test_login(self, platform, username, password):
    # ...
    if platform == '知乎':
        result = self.test_zhihu_login(username, password)
    elif platform == 'CSDN':
        result = self.test_csdn_login(username, password)
    elif platform == '新平台':
        result = self.test_新平台_login(username, password)
    # ...
```

## 使用方法

1. 访问 http://39.105.12.124:8080
2. 点击右上角 **账号配置** 按钮
3. 添加推广账号（选择平台、输入用户名密码）
4. 点击账号列表中的 **测试** 按钮
5. 查看测试结果

## 测试结果说明

- **✓ 已验证（绿色）**: 登录成功，账号有效
- **✗ 失败（红色）**: 登录失败，账号或密码错误
- **未测试（灰色）**: 尚未进行测试

## 故障排查

### 问题1：测试一直失败
**可能原因**：
- Selenium未安装
- ChromeDriver版本不匹配
- 网络问题

**解决方法**：
查看服务器日志
```bash
sudo journalctl -u topn -n 50 --no-pager | grep -i selenium
```

### 问题2：提示需要验证码
**原因**：平台检测到异常登录行为

**解决方法**：
1. 使用该IP手动登录一次
2. 或使用已信任的账号

### 问题3：Selenium环境安装失败
**解决方法**：
确保服务器系统是CentOS 7或更高版本，并有sudo权限

## 文件说明

- `backend/login_tester.py` - 登录测试核心模块
- `backend/app_with_upload.py` - 后端API，集成登录测试
- `install_selenium_server.py` - Selenium环境自动安装脚本
- `deploy_with_selenium.py` - 部署脚本

## 后续优化方向

1. **支持更多平台**：掘金、简书、今日头条等
2. **验证码处理**：集成OCR或人工介入
3. **Cookie复用**：保存登录Cookie，减少重复登录
4. **代理支持**：避免IP被封
5. **并发测试**：批量测试多个账号
