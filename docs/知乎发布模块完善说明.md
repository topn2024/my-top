# 知乎自动发布模块完善说明

## 更新时间
2025-12-06 22:32

## 服务状态
✅ topn.service 运行正常 (PID: 170288)

---

## 完善内容总览

### 1. 内容输入优化

#### 问题
- 之前使用 `editor.input(chunk, clear=False)` 分块输入时，每次调用都会覆盖之前的内容
- 导致知乎页面只显示最后一个chunk（最后一句话）

#### 解决方案
使用 **JavaScript textContent** 一次性设置完整内容：

```javascript
// 清空编辑器
this.innerHTML = '';

// 一次性设置完整文本
this.textContent = '完整的文章内容...';

// 触发input事件
var event = new Event('input', { bubbles: true });
this.dispatchEvent(event);
```

#### 优势
- ✅ 避免分块输入导致的覆盖问题
- ✅ 一次性传递完整内容
- ✅ 自动处理换行符和特殊字符
- ✅ 返回实际字符数用于验证

---

### 2. 发布流程完善（5步法）

#### 步骤1: 智能查找发布按钮
```python
publish_selectors = [
    'css:button.Button--primary',  # 主要蓝色按钮
    'text:发布文章',
    'text:发布',
    'css:button[type="submit"]',
    'css:.PublishButton',
    'css:button.Button.PublishButton.Button--primary.Button--blue',
]
```

**特点**：
- 支持6种不同的CSS选择器
- 智能匹配按钮文本（包含"发布"但不含"草稿"）
- 优先使用知乎的主要蓝色按钮
- 遍历所有匹配按钮，找到正确的发布按钮

#### 步骤2: 验证按钮状态
```python
# 滚动到按钮位置确保可见
publish_btn.run_js('this.scrollIntoView({behavior: "smooth", block: "center"})')

# 检查按钮是否被禁用
is_disabled = publish_btn.attr('disabled')
if is_disabled:
    return {'success': False, 'message': '发布按钮被禁用，可能内容未填写完整'}
```

**作用**：
- 确保按钮在视口中可见
- 提前发现内容未填写完整的问题
- 避免点击无效按钮

#### 步骤3: 点击发布按钮
```python
publish_btn.click()
logger.info("✓ 已点击发布按钮")
time.sleep(3)
```

**注意事项**：
- 等待足够时间让页面响应
- 记录详细日志便于调试

#### 步骤4: 处理确认对话框
```python
confirm_selectors = [
    'text:确认发布',
    'text:确定',
    'text:立即发布',
    'css:.Modal button.Button--primary',
    'css:.Modal button:contains("确认")',
    'css:div[role="dialog"] button.Button--primary',
]
```

**智能判断**：
- 支持6种确认按钮选择器
- 自动检测是否需要二次确认
- 如果没有确认对话框，直接进入下一步

#### 步骤5: 多重指标验证发布结果

**成功指标检查**：

1. **URL变化检查**
   ```python
   if 'write' not in current_url:
       success_indicators.append("URL已离开编辑页面")

   if '/p/' in current_url or '/zhuanlan/' in current_url:
       success_indicators.append("URL包含文章ID")
   ```

2. **页面内容检查**
   ```python
   if '发布成功' in page_text or '已发布' in page_text:
       success_indicators.append("页面显示发布成功")
   ```

3. **成功提示元素检查**
   ```python
   success_toast = self.page.ele('text:发布成功', timeout=2)
   if success_toast:
       success_indicators.append("找到成功提示")
   ```

**综合判断**：
- 如果有任一成功指标，认为发布成功
- 提取文章ID（从URL中解析）
- 返回所有成功指标列表

---

### 3. 错误处理增强

#### 自动截图功能
在以下3个关键位置自动截图：

1. **未找到发布按钮时**
   ```python
   screenshot_path = f'/tmp/zhihu_no_publish_btn_{int(time.time())}.png'
   ```

2. **发布状态不明确时**
   ```python
   screenshot_path = f'/tmp/zhihu_publish_unclear_{int(time.time())}.png'
   ```

3. **发布过程异常时**
   ```python
   screenshot_path = f'/tmp/zhihu_publish_exception_{int(time.time())}.png'
   ```

#### 详细日志输出
每个关键步骤都有清晰的日志：
```
步骤1/4: 查找发布按钮...
✓ 找到发布按钮: css:button.Button--primary, 文本='发布文章'

步骤2/4: 准备点击发布按钮...
✓ 发布按钮可用

步骤3/4: 点击发布按钮...
✓ 已点击发布按钮

步骤4/4: 检查确认对话框...
✓ 找到确认按钮: text:确认发布
✓ 已点击确认发布

步骤5/4: 验证发布结果...
✓✓ 文章发布成功! 成功指标: URL已离开编辑页面, URL包含文章ID
```

---

### 4. 返回信息增强

#### 成功时返回
```json
{
    "success": true,
    "message": "文章发布成功",
    "type": "published",
    "url": "https://zhuanlan.zhihu.com/p/123456789",
    "article_id": "123456789",
    "indicators": [
        "URL已离开编辑页面",
        "URL包含文章ID",
        "页面显示发布成功"
    ]
}
```

#### 失败时返回
```json
{
    "success": false,
    "message": "未找到发布按钮",
    "url": "https://zhuanlan.zhihu.com/write"
}
```

#### 状态不明确时返回
```json
{
    "success": true,
    "message": "文章可能已发布，请手动确认",
    "type": "published",
    "url": "https://zhuanlan.zhihu.com/...",
    "warning": "发布状态不明确，建议手动检查"
}
```

---

## 内容验证机制

### 验证流程
```python
# 1. 使用JavaScript设置内容后，返回实际字符数
result_length = editor.run_js(js_code)

# 2. 多次尝试读取编辑器内容
for attempt in range(3):
    editor_text = editor.text
    if editor_text and len(editor_text) > 100:
        break

# 3. 计算相似度
content_text = content.replace('\n\n', '').replace('\n', '').replace('\r', '')
editor_text_clean = editor_text.replace('\n', '').replace('\r', '')
similarity = len(editor_text_clean) / max(len(content_text), 1)

# 4. 验证相似度阈值（80%）
if similarity < 0.8:
    return {'success': False, 'message': f'内容输入不完整: 相似度仅{similarity*100:.1f}%'}
```

### 失败时的处理
- 返回详细错误信息给前端
- 自动截图保存到 `/tmp/zhihu_content_error_*.png`
- 阻止继续发布，避免发布不完整内容

---

## 测试建议

### 测试步骤
1. 生成一篇完整的文章（标题+正文）
2. 点击"发布到知乎"按钮
3. 系统会：
   - 使用JavaScript一次性设置完整内容
   - 验证内容相似度（≥80%）
   - 按5步法完成发布
   - 返回详细的发布结果

### 预期结果
- ✅ 知乎页面显示完整文章内容（不再只有最后一句）
- ✅ 文章成功正式发布（不只是停留在编辑页面）
- ✅ 前端收到成功消息，包含文章URL和ID
- ✅ 日志中有清晰的步骤记录

### 失败情况检查
如果发布失败，检查：
1. `/tmp/zhihu_*.png` 截图文件
2. 系统日志中的详细错误信息
3. 返回给前端的错误消息

---

## 文件位置

- **服务端代码**: `/home/u_topn/TOP_N/backend/zhihu_auto_post.py`
- **备份文件**: `/home/u_topn/TOP_N/backend/zhihu_auto_post.py.backup_*`
- **错误截图**: `/tmp/zhihu_*.png`
- **服务管理**: `sudo systemctl {start|stop|restart|status} topn`

---

## 技术栈

- **浏览器自动化**: DrissionPage
- **JavaScript执行**: textContent设置 + input事件触发
- **元素定位**: 多选择器策略 + 文本匹配
- **状态验证**: URL检查 + 页面内容检查 + 元素检查

---

## 注意事项

1. **内容格式**:
   - JavaScript会自动转义特殊字符（引号、换行、反斜杠）
   - 使用textContent保留纯文本格式

2. **发布按钮**:
   - 知乎可能更新页面结构，选择器需要定期维护
   - 当前支持6种选择器，覆盖大部分情况

3. **Cookie管理**:
   - Cookie文件存储在 `/home/u_topn/TOP_N/backend/cookies/`
   - 格式: `zhihu_{username}.json`
   - 需要定期更新Cookie以保持登录状态

4. **错误截图**:
   - 截图保存在 `/tmp/` 目录
   - 建议定期清理旧截图
   - 截图文件名包含时间戳便于追踪

---

## 更新历史

### 2025-12-06 22:32
- ✅ 修复内容输入问题（改用JavaScript textContent）
- ✅ 完善5步发布流程
- ✅ 增强错误处理和日志
- ✅ 添加多重验证指标
- ✅ 自动截图功能
- ✅ 提取文章ID功能
