# TOP_N 推广平台 - 产品特性文档

## 产品概述

TOP_N是一个AI驱动的企业推广平台，旨在帮助企业在大模型推荐中提升排名。平台通过智能分析、自动生成推广文章，并支持一键发布到主流内容平台，大幅提升企业品牌曝光度和影响力。

**核心价值**：
- 智能分析企业优势，精准定位推广方向
- AI驱动的高质量内容生成
- 自动化发布流程，节省人力成本
- 企业级权限管理，支持团队协作
- 数据持久化存储，确保内容安全

---

## 一、核心功能特性

### 1.1 智能企业分析

**功能描述**：
基于企业描述或上传的文档，利用AI大模型深度分析企业的核心竞争力、产品优势、目标用户群体等关键信息。

**技术实现**：
- 集成通义千问API (qwen-plus模型)
- 支持文本输入和文件上传两种方式
- 支持多种文档格式：TXT、PDF、Word、Excel、Markdown
- 智能提取企业亮点和推广角度

**使用场景**：
- 新产品上市前的市场定位分析
- 企业品牌重塑时的优势梳理
- 竞品分析和差异化定位

**相关文件**：
- `backend/app_with_upload.py:analyze()` - 分析API端点
- `static/input.js` - 前端输入逻辑
- `static/analysis.js` - 分析结果展示

---

### 1.2 并发文章生成

**功能描述**：
基于分析结果，并发生成多篇不同角度的推广文章，大幅缩短内容创作时间。

**技术亮点**：
- **并发处理**：使用ThreadPoolExecutor实现多线程并发生成
- **性能提升**：相比串行生成提升3-4倍速度
  - 3篇文章：从60-90秒缩短至20-30秒
  - 5篇文章：从100-150秒缩短至30-40秒
- **智能去痕**：自动移除Markdown格式和AI生成痕迹
- **多角度内容**：技术创新、用户体验、行业对比、未来趋势、案例分享

**技术实现**：
- 线程池管理（最多5个并发线程）
- 任务隔离（单个失败不影响其他）
- 结果排序（保持原始顺序）

**相关文件**：
- `backend/concurrent_article_generator.py` - 并发生成模块
- `backend/app_with_upload.py:generate_articles()` - 生成API端点
- `static/articles.js` - 文章管理前端

---

### 1.3 一键发布到知乎

**功能描述**：
支持一键将生成的文章发布到知乎平台，无需手动复制粘贴，大幅提升发布效率。

**技术特点**：
- **QR码登录**：扫码登录，安全便捷
- **Cookie持久化**：登录一次，长期有效
- **自动化发布**：DrissionPage模拟真人操作
- **发布状态追踪**：实时显示发布进度和结果
- **历史记录**：完整记录发布历史

**发布流程**：
1. 用户扫描二维码登录知乎
2. 系统保存Cookie到数据库
3. 选择要发布的文章
4. 自动填充标题和内容
5. 模拟点击发布按钮
6. 返回发布结果和文章URL

**安全机制**：
- Cookie加密存储
- 用户隔离（每个用户只能使用自己的账号）
- 发布失败自动重试
- 详细错误日志

**相关文件**：
- `backend/zhihu_publisher.py` - 知乎发布核心模块
- `backend/zhihu_auto_post_api.py` - 知乎发布API
- `static/publish.js` - 发布管理前端
- `docs/ONE_CLICK_PUBLISH_GUIDE.md` - 使用指南

---

### 1.4 平台账号管理

**功能描述**：
统一管理多平台账号，支持知乎、CSDN、掘金等主流内容平台。

**功能特点**：
- 账号CRUD操作（创建、读取、更新、删除）
- 密码加密存储（Fernet对称加密）
- 账号测试功能（验证账号有效性）
- 用户隔离（只能管理自己的账号）
- 批量导入支持

**安全措施**：
- 密码加密存储（不可逆）
- 环境变量管理加密密钥
- RBAC权限控制
- 操作日志记录

**相关文件**：
- `backend/models.py:PlatformAccount` - 账号数据模型
- `backend/encryption.py` - 密码加密工具
- `backend/app_with_upload.py:accounts()` - 账号管理API
- `accounts/accounts.json` - 账号数据备份（已迁移到数据库）

---

## 二、企业级特性

### 2.1 RBAC权限管理系统

**功能描述**：
完整的基于角色的访问控制系统，支持企业多用户协作和精细化权限管理。

**角色体系**：

**系统级角色**：
- `super_admin` - 超级管理员（平台管理）
- `platform_admin` - 平台管理员

**企业级角色**：
- `enterprise_owner` - 企业所有者（完全权限）
- `enterprise_admin` - 企业管理员（成员管理、内容管理）
- `enterprise_member` - 企业普通成员（内容创建）
- `enterprise_viewer` - 企业观察者（只读权限）

**个人用户角色**：
- `individual_user` - 个人用户（个人内容管理）

**权限类型**：
- 工作流管理：create, read, update, delete, share
- 文章管理：create, read, update, delete, publish
- 企业管理：create, read, update, delete
- 成员管理：create, read, update, delete
- 账号管理：create, read, update, delete
- 发布历史：read

**技术实现**：
- 装饰器权限检查：`@require_permission(resource, action)`
- 企业角色检查：`@require_enterprise_role(['enterprise_owner'])`
- 资源所有权检查：`@require_resource_owner(resource_type)`
- 动态权限计算（系统角色+企业角色+个人角色）

**相关文件**：
- `backend/models.py` - Role、Permission、RolePermission、EnterpriseMember模型
- `backend/rbac_permissions.py` - 权限检查装饰器和辅助函数
- `backend/enterprise_api.py` - 企业管理API
- `docs/RBAC权限系统设计.md` - 详细设计文档

---

### 2.2 企业管理

**功能描述**：
完整的企业生命周期管理，支持企业创建、信息维护、成员管理等。

**核心功能**：

**企业CRUD**：
- 创建企业（自动成为所有者）
- 查看企业列表（个人企业/全部企业）
- 更新企业信息（名称、行业、描述、联系方式）
- 删除企业（仅所有者，级联删除成员和数据）

**成员管理**：
- 添加成员（支持角色分配）
- 查看成员列表（含角色信息）
- 更新成员角色（owner/admin权限）
- 移除成员（不能移除自己）
- 成员状态管理（active/suspended/left）

**企业统计**：
- 成员数量统计
- 工作流数量统计
- 角色分布统计

**企业属性**：
- 基本信息：名称、标识码、行业、描述
- 联系信息：邮箱、电话
- Logo上传
- 成员数量限制
- 订阅计划（free/basic/pro/enterprise）
- 订阅到期时间

**相关文件**：
- `backend/models.py:Enterprise` - 企业数据模型
- `backend/enterprise_api.py` - 企业管理API
- `templates/login.html` - 企业用户注册界面

---

### 2.3 多用户认证系统

**功能描述**：
安全可靠的用户认证系统，支持个人用户和企业用户两种类型。

**用户类型**：
- **个人用户**（individual）：独立使用平台的个人
- **企业用户**（enterprise）：所属企业的成员
- **系统用户**（system）：平台管理员

**注册功能**：
- 用户类型选择（可视化图标选择）
- 企业用户自动创建企业并成为所有者
- 企业特定字段：
  - 企业名称（必填）
  - 企业标识码（自动生成或手动输入）
  - 所属行业（可选）
  - 企业规模（可选）
- 个人信息：
  - 用户名（必填，3-20字符，字母数字下划线）
  - 邮箱（必填，格式验证）
  - 密码（必填，8位以上，含大小写字母和数字）
  - 昵称（可选）
  - 联系电话（可选，11位手机号）

**登录功能**：
- 用户名/邮箱登录
- Cookie持久化登录（7天免登录）
- Session管理（24小时有效期）
- 登录状态检测
- 自动登出功能

**安全措施**：
- 密码PBKDF2哈希（不可逆）
- Session密钥加密
- 防止SQL注入
- XSS防护
- CSRF保护

**表单验证**：
- 实时字段验证（onblur事件）
- 密码强度指示器（弱/中/强）
- 格式验证（用户名、邮箱、手机号、企业标识码）
- 重复密码确认
- 视觉反馈（绿色勾/红色叉）

**相关文件**：
- `backend/auth.py` - 认证核心模块
- `backend/models.py:User` - 用户数据模型
- `templates/login.html` - 登录注册页面（703行完整实现）
- `static/auth.js` - 登录逻辑

---

## 三、数据持久化

### 3.1 MySQL数据库存储

**功能描述**：
完全基于MySQL的数据持久化方案，替代localStorage，确保数据安全和多端访问。

**数据库信息**：
- 服务器：39.105.12.124:3306
- 数据库：topn_platform
- ORM：SQLAlchemy 2.0

**核心数据表**：

**用户相关**：
- `users` - 用户表（用户名、邮箱、密码、类型、角色）
- `roles` - 角色表（角色名、代码、类型）
- `permissions` - 权限表（资源、操作、代码）
- `role_permissions` - 角色权限关联表

**企业相关**：
- `enterprises` - 企业表（名称、标识码、行业、订阅）
- `enterprise_members` - 企业成员表（企业、用户、角色、状态）

**业务相关**：
- `workflows` - 工作流表（用户、企业、公司信息、分析结果、步骤、状态）
- `articles` - 文章表（工作流、标题、内容、类型、顺序）
- `platform_accounts` - 平台账号表（用户、平台、账号、加密密码）
- `publish_history` - 发布历史表（文章、用户、平台、状态、URL）

**数据关系**：
- User → Workflows (1对多)
- Workflow → Articles (1对多)
- User → PlatformAccounts (1对多)
- User → EnterpriseMember (1对多)
- Enterprise → EnterpriseMember (1对多)
- Enterprise → Workflows (1对多)

**相关文件**：
- `backend/models.py` - 完整ORM模型定义
- `backend/init_db.py` - 数据库初始化脚本
- `backend/database.py` - 数据库连接管理

---

### 3.2 工作流状态管理

**功能描述**：
持久化的工作流状态管理，支持多步骤流程的保存和恢复。

**工作流步骤**：
1. 输入信息（公司名称、描述、文件上传）
2. 分析生成（AI分析企业优势）
3. 生成文章（并发生成多篇推广文章）
4. 发布推广（选择平台和文章发布）

**状态字段**：
- `current_step` - 当前步骤（1-4）
- `status` - 工作流状态（draft/processing/completed/failed）
- `company_name` - 公司名称
- `company_desc` - 公司描述
- `uploaded_text` - 上传的文本内容
- `uploaded_filename` - 上传的文件名
- `analysis` - AI分析结果（JSON格式）
- `article_count` - 生成的文章数量
- `platforms` - 选择的发布平台（JSON数组）
- `visibility` - 可见性（private/team/public）

**API端点**：
- `GET /api/workflow/current` - 获取当前工作流（最新未完成）
- `POST /api/workflow/save` - 保存/更新工作流
- `GET /api/workflow/list` - 获取用户所有工作流
- `GET /api/workflow/<id>` - 获取指定工作流详情

**前端状态管理**：
```javascript
const WorkflowState = {
    async init() - 从API加载当前工作流
    async get() - 获取工作流状态
    async save(state) - 保存完整状态
    async update(partialState) - 部分更新
}
```

**相关文件**：
- `backend/models.py:Workflow` - 工作流数据模型
- `backend/app_with_upload.py` - 工作流API端点
- `static/state.js` - 前端状态管理（完全重写为API-based）

---

## 四、用户体验特性

### 4.1 渐进式表单设计

**功能描述**：
根据用户选择动态显示相关字段，避免信息过载，提升填写体验。

**设计原则**：
- 先选择用户类型，再显示对应字段
- 企业特定字段仅对企业用户显示
- 可选字段折叠，必填字段突出
- 视觉层次清晰

**实现细节**：
- 用户类型选择器（大图标+描述）
- 企业字段容器（`display: none` 默认隐藏）
- JavaScript动态控制显示/隐藏
- 动态添加/移除required属性

**相关文件**：
- `templates/login.html:selectUserType()` - 用户类型切换函数

---

### 4.2 实时表单验证

**功能描述**：
表单输入时即时验证，提供即时反馈，减少提交错误。

**验证项目**：
- 用户名：3-20字符，字母数字下划线
- 邮箱：标准邮箱格式
- 密码：8位以上，含大小写字母和数字
- 手机号：11位数字
- 企业标识码：字母数字下划线，3-20字符

**验证时机**：
- `onblur` - 失去焦点时验证
- `oninput` - 密码强度实时计算
- `onsubmit` - 提交前整体验证

**视觉反馈**：
- 绿色勾号 - 验证通过
- 红色叉号 - 验证失败
- 错误提示文本（红色）
- 输入框边框颜色变化

**密码强度指示器**：
- 弱：仅数字或仅字母，短于8位
- 中：含字母和数字，8位以上
- 强：含大小写字母、数字，10位以上

**相关文件**：
- `templates/login.html` - 完整验证逻辑（validateUsername, validateEmail, validatePassword等）

---

### 4.3 响应式导航设计

**功能描述**：
清晰的页面导航，避免元素重叠，优化用户流程。

**设计特点**：
- Flexbox布局（`justify-content: space-between`）
- 左侧：返回首页链接
- 右侧：功能按钮组（账号配置、登录/注册）
- 一致的样式风格（绿色主题）
- 悬停效果（transition动画）

**页面覆盖**：
- `/` - 首页
- `/platform` - 平台输入页面
- `/publish` - 发布管理页面

**样式规范**：
- 字体大小：14px
- 内边距：6px 12px
- 边框：1-2px solid #4CAF50
- 圆角：4px
- 间距：10-20px

**相关文件**：
- `templates/input.html` - 平台页面导航
- `templates/publish.html` - 发布页面导航

---

### 4.4 登录状态提示

**功能描述**：
访问登录页面时，如果已登录则显示友好提示而非自动跳转。

**设计理念**：
- 尊重用户意图（可能想切换账号）
- 提供明确选择（进入平台/退出登录）
- 显示当前登录用户名

**提示内容**：
```
✓ 您已登录为: [用户名]
[进入平台] [退出登录]
```

**样式特点**：
- 浅绿色背景（#e8f5e9）
- 绿色边框（#4CAF50）
- 居中布局
- 清晰的按钮区分

**相关文件**：
- `templates/login.html:checkAuth()` - 登录检测函数

---

## 五、技术架构特性

### 5.1 前后端分离架构

**技术栈**：
- **后端**：Flask 3.0 + Python 3.8+
- **数据库**：MySQL 8.0 + SQLAlchemy 2.0
- **前端**：原生JavaScript (ES6+) + HTML5 + CSS3
- **AI服务**：通义千问API (qwen-plus)
- **自动化**：DrissionPage (浏览器自动化)

**架构特点**：
- RESTful API设计
- JSON数据交换
- Async/Await异步调用
- Session认证
- CORS支持

**相关文件**：
- `backend/app_with_upload.py` - Flask主应用
- `static/*.js` - 前端JavaScript模块
- `templates/*.html` - HTML模板

---

### 5.2 模块化代码组织

**后端模块**：
- `models.py` - 数据模型（SQLAlchemy ORM）
- `auth.py` - 认证模块（用户登录注册）
- `rbac_permissions.py` - 权限检查
- `enterprise_api.py` - 企业管理API
- `zhihu_publisher.py` - 知乎发布核心
- `zhihu_auto_post_api.py` - 知乎发布API
- `concurrent_article_generator.py` - 并发文章生成
- `encryption.py` - 密码加密工具
- `database.py` - 数据库连接管理

**前端模块**：
- `state.js` - 状态管理（API-based）
- `input.js` - 输入页面逻辑
- `analysis.js` - 分析页面逻辑
- `articles.js` - 文章管理逻辑
- `publish.js` - 发布管理逻辑
- `auth.js` - 登录认证逻辑

**配置文件**：
- `requirements.txt` - Python依赖
- `.env` - 环境变量（API密钥、数据库密码、加密密钥）

---

### 5.3 安全机制

**密码安全**：
- PBKDF2 + SHA256哈希
- 每个密码独立盐值
- 不可逆加密

**平台账号密码加密**：
- Fernet对称加密
- 环境变量存储密钥
- 数据库仅存储密文

**Session安全**：
- 服务器端Session
- HttpOnly Cookie
- 24小时过期时间
- Secret Key签名

**API安全**：
- `@login_required` 装饰器
- RBAC权限检查
- 资源所有权验证
- SQL注入防护（ORM参数化查询）
- XSS防护（输入转义）

**相关文件**：
- `backend/auth.py` - 密码哈希函数
- `backend/encryption.py` - Fernet加密
- `backend/rbac_permissions.py` - 权限装饰器

---

### 5.4 性能优化

**并发处理**：
- ThreadPoolExecutor线程池
- 最多5个并发线程
- 任务隔离和错误处理
- 3-4倍性能提升

**数据库优化**：
- 连接池管理
- 索引优化（user_id, enterprise_id, status等）
- 外键约束
- 级联删除

**前端优化**：
- 按需加载（Progressive Disclosure）
- 实时验证（减少服务器请求）
- 本地状态缓存
- 异步API调用

**相关文件**：
- `backend/concurrent_article_generator.py` - 并发生成
- `backend/database.py` - 连接池管理
- `backend/models.py` - 数据库索引定义

---

## 六、部署和运维

### 6.1 生产环境部署

**服务器配置**：
- 服务器IP：39.105.12.124
- 应用端口：8080
- 数据库端口：3306

**部署方式**：
- Gunicorn WSGI服务器（6个worker进程）
- Systemd服务管理
- 服务名：topn

**启动命令**：
```bash
gunicorn -w 6 -b 0.0.0.0:8080 app_with_upload:app
```

**服务管理**：
```bash
sudo systemctl start topn     # 启动服务
sudo systemctl stop topn      # 停止服务
sudo systemctl restart topn   # 重启服务
sudo systemctl status topn    # 查看状态
```

**环境变量**：
- `QIANWEN_API_KEY` - 通义千问API密钥
- `DB_PASSWORD` - MySQL数据库密码
- `ENCRYPTION_KEY` - Fernet加密密钥
- `SECRET_KEY` - Flask Session密钥

---

### 6.2 数据库管理

**初始化脚本**：
- `backend/init_db.py` - 创建数据库和表
- `backend/create_admin.py` - 创建管理员用户
- `backend/migrate_accounts.py` - 迁移账号数据

**数据迁移**：
- 从localStorage迁移到MySQL
- 从accounts.json迁移到platform_accounts表
- 保留原始数据备份

**数据备份**：
- 定期备份MySQL数据库
- 保留accounts.json备份文件

---

### 6.3 日志和监控

**日志系统**：
- Python logging模块
- 文件日志 + 控制台输出
- 日志级别：INFO, WARNING, ERROR
- 详细的错误堆栈跟踪

**关键日志点**：
- 用户登录/注册
- 工作流创建/更新
- 文章生成（成功/失败）
- 发布操作（成功/失败）
- 数据库操作错误
- API调用错误

**相关代码**：
```python
logger = logging.getLogger(__name__)
logger.info(f'用户 {username} 登录成功')
logger.error(f'生成文章失败: {str(e)}', exc_info=True)
```

---

## 七、未来规划特性

### 7.1 多平台支持扩展

**计划支持平台**：
- ✅ 知乎（已实现）
- 🔲 CSDN
- 🔲 掘金
- 🔲 微信公众号
- 🔲 今日头条
- 🔲 知乎专栏

**技术方案**：
- 统一发布接口抽象
- 平台特定适配器
- Cookie管理优化

---

### 7.2 内容质量提升

**计划功能**：
- 文章去重检测
- SEO优化建议
- 关键词密度分析
- 可读性评分
- 图片自动配图
- 内链推荐

---

### 7.3 数据分析和报表

**计划功能**：
- 发布效果统计
- 阅读量追踪
- 用户行为分析
- 企业数据看板
- 导出报表（Excel/PDF）

---

### 7.4 智能推荐

**计划功能**：
- 发布时间推荐
- 平台选择推荐
- 标题优化建议
- 标签推荐
- 相关企业推荐

---

## 八、技术文档索引

### 8.1 完整文档列表

1. **RBAC权限系统设计.md** - RBAC权限系统完整设计文档
2. **ONE_CLICK_PUBLISH_GUIDE.md** - 知乎一键发布使用指南
3. **ZHIHU_AUTO_POST_README.md** - 知乎自动发布API文档
4. **Cookie登录功能使用说明.md** - Cookie登录详细说明
5. **产品特性文档.md** - 本文档

### 8.2 关键API端点汇总

**认证相关**：
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/me` - 获取当前用户信息

**工作流相关**：
- `POST /api/analyze` - 企业分析
- `POST /api/generate_articles` - 并发生成文章
- `GET /api/workflow/current` - 获取当前工作流
- `POST /api/workflow/save` - 保存工作流
- `GET /api/workflow/list` - 工作流列表

**账号管理**：
- `GET /api/accounts` - 获取平台账号列表
- `POST /api/accounts` - 添加平台账号
- `PUT /api/accounts/<id>` - 更新账号
- `DELETE /api/accounts/<id>` - 删除账号
- `POST /api/accounts/<id>/test` - 测试账号

**企业管理**：
- `POST /api/enterprises` - 创建企业
- `GET /api/enterprises` - 企业列表
- `GET /api/enterprises/<id>` - 企业详情
- `PUT /api/enterprises/<id>` - 更新企业
- `DELETE /api/enterprises/<id>` - 删除企业
- `GET /api/enterprises/<id>/members` - 成员列表
- `POST /api/enterprises/<id>/members` - 添加成员
- `PUT /api/enterprises/<id>/members/<user_id>` - 更新成员角色
- `DELETE /api/enterprises/<id>/members/<user_id>` - 移除成员
- `GET /api/enterprises/<id>/stats` - 企业统计

**知乎发布**：
- `GET /api/zhihu/qrcode` - 获取登录二维码
- `GET /api/zhihu/check_login` - 检查登录状态
- `POST /api/zhihu/publish` - 发布文章到知乎
- `GET /api/zhihu/cookie_status` - Cookie状态检查
- `DELETE /api/zhihu/logout` - 清除Cookie

**发布历史**：
- `GET /api/publish_history` - 获取发布历史

---

## 九、快速开始指南

### 9.1 个人用户使用流程

1. **注册账号**：访问 http://39.105.12.124:8080/login，选择"个人用户"，填写信息注册
2. **登录系统**：使用用户名/邮箱和密码登录
3. **输入企业信息**：在平台页面输入公司名称和描述（或上传文档）
4. **生成分析**：点击"开始分析"，等待AI分析结果
5. **生成文章**：选择文章数量（建议3-5篇），点击"生成文章"
6. **配置账号**：在账号配置中添加知乎账号
7. **发布文章**：选择文章和平台，点击"开始发布"

### 9.2 企业用户使用流程

1. **注册企业**：选择"企业用户"，填写企业信息和个人信息
2. **邀请成员**：在企业管理中添加团队成员并分配角色
3. **团队协作**：不同成员根据权限创建和管理内容
4. **数据共享**：企业内成员共享工作流和文章（基于权限）

---

## 十、联系和支持

**项目地址**：D:\work\code\TOP_N
**服务器**：http://39.105.12.124:8080
**文档目录**：docs/

**开发团队**：TOP_N Platform Development Team
**最后更新**：2024年

---

**版本**：v1.0
**文档状态**：✅ 完成
