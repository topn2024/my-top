# TOP_N服务环境变量配置说明

## 更新时间
2025-12-05 18:11

## 问题诊断

### 发现的问题
通过检查发现topn服务的环境变量配置不完整,主要问题:

1. **PATH不完整**: 只包含虚拟环境路径,缺少系统路径
   - 原配置: `PATH=/home/u_topn/TOP_N/venv/bin`
   - 问题: Chrome无法找到系统依赖库

2. **缺少HOME变量**: 某些应用程序需要HOME环境变量

3. **缺少服务依赖**: 没有明确指定依赖xvfb服务

## 配置更新

### 更新前的配置
```ini
[Service]
Environment="DISPLAY=:99"
Type=simple
User=u_topn
WorkingDirectory=/home/u_topn/TOP_N/backend
Environment=PATH=/home/u_topn/TOP_N/venv/bin
ExecStart=/home/u_topn/TOP_N/venv/bin/python3 app_with_upload.py
```

### 更新后的配置
```ini
[Unit]
Description=TOP_N Platform
After=network.target xvfb.service
Wants=xvfb.service

[Service]
Type=simple
User=u_topn
WorkingDirectory=/home/u_topn/TOP_N/backend

# 环境变量配置
Environment="DISPLAY=:99"
Environment="HOME=/home/u_topn"
Environment="PATH=/home/u_topn/TOP_N/venv/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin"
Environment="PYTHONUNBUFFERED=1"

# 启动命令
ExecStart=/home/u_topn/TOP_N/venv/bin/python3 app_with_upload.py

# 重启配置
Restart=always
RestartSec=10

# 日志配置
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

## 环境变量说明

### 1. DISPLAY=:99
- **作用**: 指定X显示服务器
- **重要性**: Chrome即使在headless模式下也需要DISPLAY
- **关联**: 依赖xvfb服务在:99显示上运行

### 2. HOME=/home/u_topn
- **作用**: 指定用户主目录
- **重要性**: 
  - Chrome需要HOME来创建配置目录
  - 某些库需要访问用户目录
  - 临时文件和缓存目录需要HOME

### 3. PATH (完整路径)
```
/home/u_topn/TOP_N/venv/bin    # Python虚拟环境
/usr/local/bin                  # 本地安装的程序
/usr/bin                        # 系统程序
/bin                            # 基本命令
/usr/local/sbin                 # 本地系统管理程序
/usr/sbin                       # 系统管理程序
```

- **作用**: 程序搜索路径
- **重要性**: 
  - Chrome需要访问系统命令和库
  - ChromeDriver需要找到Chrome
  - 依赖库需要完整的系统路径

### 4. PYTHONUNBUFFERED=1
- **作用**: Python不缓冲输出
- **重要性**: 日志实时输出到systemd journal,便于调试

## 服务依赖配置

### After=network.target xvfb.service
- 确保在网络和xvfb启动后才启动topn服务

### Wants=xvfb.service
- 建议启动xvfb服务,但不是强制依赖

## 验证配置

### 1. 查看当前环境变量
```bash
sudo systemctl show topn --property=Environment
```

应该显示:
```
Environment=DISPLAY=:99 HOME=/home/u_topn PATH=/home/u_topn/TOP_N/venv/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin PYTHONUNBUFFERED=1
```

### 2. 检查服务状态
```bash
sudo systemctl status topn
```

### 3. 查看日志
```bash
# 实时查看
./view_topn_logs.sh tail

# 查看最近100行
./view_topn_logs.sh last 100
```

## ChromeDriver检查结果

### 安装位置
- **路径**: `/home/u_topn/chromedriver`
- **版本**: ChromeDriver 143.0.7498.0
- **Chrome版本**: Google Chrome 143.0.7499.40
- **版本匹配**: ✓ 主版本号都是143

### 权限
- **文件权限**: `-rwxrwxr-x`
- **所有者**: `u_topn:u_topn`
- **可执行**: ✓ 是

### 功能测试
- **启动测试**: ✓ 可以正常启动
- **help命令**: ✓ 正常响应

## Xvfb服务状态

- **服务状态**: active (运行中)
- **显示编号**: :99
- **systemd单元**: xvfb.service

## 备份

原配置已备份到:
```
/etc/systemd/system/topn.service.backup
```

## 回滚方法

如果需要恢复到之前的配置:
```bash
sudo cp /etc/systemd/system/topn.service.backup /etc/systemd/system/topn.service
sudo systemctl daemon-reload
sudo systemctl restart topn
```

## 测试建议

1. 访问Web界面
2. 配置一个测试账号
3. 点击"测试登录"按钮
4. 使用以下命令实时查看详细日志:
   ```bash
   ./view_topn_logs.sh tail
   ```
5. 检查日志中的WebDriver初始化过程

## 预期日志输出

成功初始化WebDriver时应该看到:
```
2025-12-05 18:11:23 - login_tester - INFO - Initializing WebDriver (headless=True)
2025-12-05 18:11:23 - login_tester - DEBUG - Current DISPLAY environment: :99
2025-12-05 18:11:23 - login_tester - DEBUG - Detected platform: Linux
2025-12-05 18:11:23 - login_tester - INFO - Chrome binary location: /usr/bin/google-chrome
2025-12-05 18:11:23 - login_tester - INFO - Found ChromeDriver at: /home/u_topn/chromedriver
2025-12-05 18:11:24 - login_tester - INFO - ✓ WebDriver initialized successfully with: /home/u_topn/chromedriver
```

## 可能仍需解决的问题

即使配置了完整的环境变量,Chrome可能还需要:

1. **字体库**: Chrome渲染可能需要字体
   ```bash
   sudo yum install -y liberation-fonts
   ```

2. **其他依赖库**: 检查Chrome缺少的库
   ```bash
   ldd /usr/bin/google-chrome | grep "not found"
   ```

3. **临时目录权限**: 确保u_topn用户可以写入/tmp

如果仍然遇到问题,请查看详细日志并根据错误信息进一步调试。
