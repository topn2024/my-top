# TOP_N 服务日志报错解决方案

## 问题总结

在服务运行过程中发现的主要问题：

### 1. 文件上传错误 (已解决)
**错误**: "文件上传失败: 无法提取文件内容"
**根本原因**:
- 错误的 docx 导入语句：`import docx` 应该是 `from docx import Document`
- 缺乏详细的错误日志记录

**解决方案**:
1. 修正了 docx 导入方式
2. 添加了条件导入，优雅处理库缺失
3. 增强了多编码支持（utf-8, gbk, gb2312, gb18030, latin1）
4. 添加了详细的日志记录系统

## 实施的改进

### 1. 引入 Python logging 模块

```python
import logging
import sys

# 配置日志
logging.basicConfig(
    stream=sys.stdout,
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)
```

### 2. 条件导入文档处理库

```python
try:
    from docx import Document
    DOCX_AVAILABLE = True
except ImportError:
    DOCX_AVAILABLE = False
    logger.warning("python-docx not available, .doc/.docx support disabled")

try:
    import PyPDF2
    PDF_AVAILABLE = True
except ImportError:
    PDF_AVAILABLE = False
    logger.warning("PyPDF2 not available, PDF support disabled")
```

### 3. 详细的上传日志记录

每个上传请求现在都会记录：
- 文件名
- 保存路径
- 文本提取状态
- 文本长度
- 任何错误和异常（包含完整堆栈跟踪）

### 4. 改进的错误处理

```python
if text is None:
    ext = filepath.rsplit('.', 1)[1].lower()
    error_msg = ''
    if ext == 'pdf' and not PDF_AVAILABLE:
        error_msg = '服务器未安装PDF处理库，请使用TXT或MD格式'
    elif ext in ['doc', 'docx'] and not DOCX_AVAILABLE:
        error_msg = '服务器未安装Word文档处理库，请使用TXT或MD格式'
    else:
        error_msg = '无法提取文件内容，请检查文件格式或内容'

    logger.error(f"Text extraction failed for {filepath}: {error_msg}")
    return jsonify({'error': error_msg}), 500
```

## 查看日志的方法

### 实时查看详细日志
```bash
journalctl -u topn -f
```

### 查看上传相关日志
```bash
journalctl -u topn --since "10 minutes ago" --no-pager | grep -E "(INFO|ERROR|WARNING)"
```

### 查看错误日志
```bash
journalctl -u topn -p err --no-pager
```

## 日志输出示例

### 成功上传
```
2025-12-04 21:22:51,291 - __main__ - INFO - Uploading file: test_upload.txt
2025-12-04 21:22:51,291 - __main__ - INFO - File saved to: ../uploads/20251204_212251_test_upload.txt
2025-12-04 21:22:51,291 - __main__ - INFO - File uploaded successfully: test_upload.txt, text length: 106
2025-12-04 21:22:51,292 - werkzeug - INFO - 120.229.71.136 - - [04/Dec/2025 21:22:51] "POST /api/upload HTTP/1.1" 200 -
```

### 上传失败（示例）
```
2025-12-04 21:XX:XX,XXX - __main__ - INFO - Uploading file: document.docx
2025-12-04 21:XX:XX,XXX - __main__ - INFO - File saved to: ../uploads/20251204_XXXXXX_document.docx
2025-12-04 21:XX:XX,XXX - __main__ - ERROR - Text extraction failed for ../uploads/20251204_XXXXXX_document.docx: 服务器未安装Word文档处理库，请使用TXT或MD格式
2025-12-04 21:XX:XX,XXX - werkzeug - INFO - 120.229.71.136 - - [04/Dec/2025 21:XX:XX] "POST /api/upload HTTP/1.1" 500 -
```

## 当前状态

✅ **服务运行正常**: http://39.105.12.124:8080
✅ **文件上传功能正常**: 支持 TXT, PDF, DOC, DOCX, MD
✅ **详细日志记录**: 所有操作都有完整日志
✅ **错误处理完善**: 清晰的错误提示信息

## 测试结果

- TXT 文件上传: ✅ 成功
- 多编码文本支持: ✅ 支持 utf-8, gbk, gb2312 等
- 日志记录: ✅ 详细且清晰
- 错误捕获: ✅ 完整的异常堆栈

## 未来可能的优化

1. 添加文件上传大小限制提示
2. 支持更多文档格式（如 RTF, ODT 等）
3. 添加文件内容预览功能
4. 实现日志文件归档和清理机制

## 文件位置

- **后端代码**: `/home/u_topn/TOP_N/backend/app.py`
- **上传目录**: `/home/u_topn/TOP_N/uploads/`
- **服务配置**: `/etc/systemd/system/topn.service`
- **本地代码**: `D:\work\code\TOP_N\backend\app_with_upload.py`

## 服务管理

```bash
# 重启服务
systemctl restart topn

# 查看状态
systemctl status topn

# 查看日志
journalctl -u topn -f
```

---
**最后更新**: 2025-12-04
**状态**: 所有已知问题已解决
