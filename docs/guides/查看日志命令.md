# TOP_N 服务日志查看指南

## 连接服务器
```bash
ssh root@39.105.12.124
# 密码: sfwef2GERGSE@#645
```

## 常用日志查看命令

### 1. 查看实时日志（最常用，推荐）
```bash
journalctl -u topn -f
```
按 `Ctrl+C` 退出

### 2. 查看最近的日志
```bash
# 最后 50 条
journalctl -u topn -n 50 --no-pager

# 最后 100 条
journalctl -u topn -n 100 --no-pager

# 最后 200 条
journalctl -u topn -n 200 --no-pager
```

### 3. 按时间查看日志
```bash
# 查看今天的日志
journalctl -u topn --since today --no-pager

# 查看最近 10 分钟的日志
journalctl -u topn --since "10 minutes ago" --no-pager

# 查看最近 1 小时的日志
journalctl -u topn --since "1 hour ago" --no-pager

# 查看指定时间段的日志
journalctl -u topn --since "2025-12-04 20:00:00" --until "2025-12-04 21:00:00" --no-pager
```

### 4. 只查看错误日志
```bash
# 只看错误级别的日志
journalctl -u topn -p err --no-pager

# 错误和警告
journalctl -u topn -p warning --no-pager
```

### 5. 搜索特定关键词
```bash
# 搜索包含 "Error" 的日志
journalctl -u topn --no-pager | grep -i error

# 搜索包含 "Exception" 的日志
journalctl -u topn --no-pager | grep -i exception

# 搜索上传相关的日志
journalctl -u topn --no-pager | grep -i upload

# 搜索 POST 请求
journalctl -u topn --no-pager | grep POST
```

### 6. 查看服务状态
```bash
# 查看服务运行状态
systemctl status topn

# 查看服务是否启用
systemctl is-enabled topn

# 查看服务是否正在运行
systemctl is-active topn
```

### 7. 组合使用
```bash
# 查看最近 30 分钟内包含 Error 的日志
journalctl -u topn --since "30 minutes ago" --no-pager | grep -i error

# 查看今天的 POST 请求及其响应码
journalctl -u topn --since today --no-pager | grep POST

# 实时查看并过滤错误
journalctl -u topn -f | grep -i error
```

## 服务管理命令

### 重启服务
```bash
systemctl restart topn
```

### 停止服务
```bash
systemctl stop topn
```

### 启动服务
```bash
systemctl start topn
```

### 查看服务配置
```bash
cat /etc/systemd/system/topn.service
```

## 应用相关路径

- **应用目录**: `/home/u_topn/TOP_N`
- **后端代码**: `/home/u_topn/TOP_N/backend/app.py`
- **上传目录**: `/home/u_topn/TOP_N/uploads`
- **数据目录**: `/home/u_topn/TOP_N/data`
- **虚拟环境**: `/home/u_topn/TOP_N/venv`

## 常见问题诊断

### 问题1: 服务无法启动
```bash
# 查看详细错误信息
journalctl -u topn -n 50 --no-pager

# 查看启动失败的具体原因
systemctl status topn -l
```

### 问题2: 文件上传失败
```bash
# 查看上传相关的错误
journalctl -u topn --since "10 minutes ago" --no-pager | grep -E "(upload|Upload)"

# 检查上传目录权限
ls -la /home/u_topn/TOP_N/uploads
```

### 问题3: AI 分析失败
```bash
# 查看千问 API 调用相关的日志
journalctl -u topn --no-pager | grep -E "(analyze|qwen|openai)"
```

### 问题4: 找不到日志输出
```bash
# 确认服务是否在运行
systemctl status topn

# 查看所有日志（包括历史）
journalctl -u topn --no-pager
```

## 日志级别说明

- **emerg** (0): 系统不可用
- **alert** (1): 必须立即采取行动
- **crit** (2): 临界条件
- **err** (3): 错误条件
- **warning** (4): 警告条件
- **notice** (5): 正常但重要的条件
- **info** (6): 信息性消息
- **debug** (7): 调试级别消息

## 实用技巧

### 导出日志到文件
```bash
# 导出今天的日志
journalctl -u topn --since today --no-pager > /tmp/topn_today.log

# 导出最近的错误日志
journalctl -u topn -p err --no-pager > /tmp/topn_errors.log
```

### 清理旧日志（谨慎操作）
```bash
# 查看日志占用空间
journalctl --disk-usage

# 清理 7 天前的日志
journalctl --vacuum-time=7d

# 限制日志大小为 500M
journalctl --vacuum-size=500M
```

## 访问地址

- **首页**: http://39.105.12.124:8080
- **健康检查**: http://39.105.12.124:8080/api/health
