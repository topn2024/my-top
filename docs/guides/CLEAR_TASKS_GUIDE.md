# å‘å¸ƒä»»åŠ¡æ¸…ç†åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

æ–°å¢äº†æ‰‹åŠ¨æ¸…ç†é˜Ÿåˆ—ä¸­å‘å¸ƒä»»åŠ¡çš„åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·æ‰¹é‡åˆ é™¤å·²å®Œæˆçš„ä»»åŠ¡è®°å½•ï¼Œä¿æŒä»»åŠ¡åˆ—è¡¨æ•´æ´ã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. æ”¯æŒçš„æ¸…ç†æ–¹å¼

- **æ¸…ç†æˆåŠŸä»»åŠ¡**ï¼šåˆ é™¤æ‰€æœ‰çŠ¶æ€ä¸º `success` çš„ä»»åŠ¡
- **æ¸…ç†å¤±è´¥ä»»åŠ¡**ï¼šåˆ é™¤æ‰€æœ‰çŠ¶æ€ä¸º `failed` çš„ä»»åŠ¡
- **æ¸…ç†å…¨éƒ¨å·²å®Œæˆ**ï¼šåˆ é™¤æ‰€æœ‰çŠ¶æ€ä¸º `success`ã€`failed`ã€`cancelled` çš„ä»»åŠ¡
- **æŒ‰ä»»åŠ¡IDæ¸…ç†**ï¼šåˆ é™¤æŒ‡å®šçš„ä»»åŠ¡IDåˆ—è¡¨

### 2. å®‰å…¨ä¿æŠ¤

- âœ… **æƒé™éªŒè¯**ï¼šåªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„ä»»åŠ¡
- âœ… **çŠ¶æ€æ£€æŸ¥**ï¼šä¸å…è®¸åˆ é™¤æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆ`pending`ã€`queued`ã€`running`ï¼‰
- âœ… **äºŒæ¬¡ç¡®è®¤**ï¼šåˆ é™¤å‰éœ€è¦ç”¨æˆ·ç¡®è®¤
- âœ… **ä¸å¯æ’¤é”€æç¤º**ï¼šæ˜ç¡®å‘ŠçŸ¥åˆ é™¤æ“ä½œä¸å¯æ¢å¤

## å‰ç«¯ä½¿ç”¨

### å‘å¸ƒé¡µé¢æŒ‰é’®

åœ¨ `/publish` é¡µé¢çš„å‘å¸ƒå†å²åŒºåŸŸï¼Œæä¾›äº†ä¸‰ä¸ªæ¸…ç†æŒ‰é’®ï¼š

```
ğŸ—‘ï¸ æ¸…ç†æˆåŠŸä»»åŠ¡    - æ¸…ç†æ‰€æœ‰æˆåŠŸå‘å¸ƒçš„ä»»åŠ¡
ğŸ—‘ï¸ æ¸…ç†å¤±è´¥ä»»åŠ¡    - æ¸…ç†æ‰€æœ‰å‘å¸ƒå¤±è´¥çš„ä»»åŠ¡
ğŸ—‘ï¸ æ¸…ç†å…¨éƒ¨å·²å®Œæˆ  - æ¸…ç†æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡ï¼ˆæˆåŠŸ+å¤±è´¥+å·²å–æ¶ˆï¼‰
```

### ä½¿ç”¨æ­¥éª¤

1. è®¿é—®å‘å¸ƒé¡µé¢ï¼š`http://your-server:8080/publish`
2. åœ¨"å‘å¸ƒå†å²"åŒºåŸŸæ‰¾åˆ°æ¸…ç†æŒ‰é’®
3. ç‚¹å‡»å¯¹åº”çš„æ¸…ç†æŒ‰é’®
4. åœ¨å¼¹å‡ºçš„ç¡®è®¤å¯¹è¯æ¡†ä¸­ç¡®è®¤æ“ä½œ
5. ç­‰å¾…æ¸…ç†å®Œæˆï¼ŒæŸ¥çœ‹ç»“æœæç¤º
6. é¡µé¢è‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºæœ€æ–°çš„ä»»åŠ¡åˆ—è¡¨

## åç«¯ API

### API ç«¯ç‚¹

```
POST /task/clear
```

### è¯·æ±‚å‚æ•°

**æ–¹å¼ä¸€ï¼šæŒ‰çŠ¶æ€æ‰¹é‡æ¸…ç†**

```json
{
    "status_filter": ["success", "failed", "cancelled"]
}
```

**æ–¹å¼äºŒï¼šæŒ‰ä»»åŠ¡IDæ¸…ç†**

```json
{
    "task_ids": ["uuid-1", "uuid-2", "uuid-3"]
}
```

### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”**

```json
{
    "success": true,
    "deleted_count": 10,
    "failed_count": 0,
    "errors": null,
    "message": "æˆåŠŸæ¸…ç† 10 ä¸ªä»»åŠ¡"
}
```

**éƒ¨åˆ†å¤±è´¥å“åº”**

```json
{
    "success": true,
    "deleted_count": 8,
    "failed_count": 2,
    "errors": [
        "ä»»åŠ¡ xxx çŠ¶æ€ä¸º runningï¼Œæ— æ³•åˆ é™¤ï¼Œè¯·å…ˆå–æ¶ˆ",
        "ä»»åŠ¡ yyy ä¸å­˜åœ¨æˆ–æ— æƒé™"
    ],
    "message": "æˆåŠŸæ¸…ç† 8 ä¸ªä»»åŠ¡ï¼Œ2 ä¸ªå¤±è´¥"
}
```

**å¤±è´¥å“åº”**

```json
{
    "success": false,
    "error": "å¿…é¡»æŒ‡å®štask_idsæˆ–status_filterå‚æ•°",
    "message": "å‚æ•°é”™è¯¯"
}
```

## ä»£ç ç¤ºä¾‹

### JavaScript è°ƒç”¨ç¤ºä¾‹

```javascript
// æ¸…ç†æ‰€æœ‰æˆåŠŸçš„ä»»åŠ¡
async function clearSuccessTasks() {
    const response = await fetch('/task/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            status_filter: ['success']
        })
    });

    const data = await response.json();

    if (data.success) {
        console.log(`å·²åˆ é™¤ ${data.deleted_count} ä¸ªä»»åŠ¡`);
    } else {
        console.error(`æ¸…ç†å¤±è´¥: ${data.error}`);
    }
}

// æ¸…ç†æŒ‡å®šä»»åŠ¡
async function clearSpecificTasks(taskIds) {
    const response = await fetch('/task/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            task_ids: taskIds
        })
    });

    const data = await response.json();
    return data;
}
```

### Python è°ƒç”¨ç¤ºä¾‹

```python
from backend.services.task_queue_manager import get_task_manager

# è·å–ä»»åŠ¡ç®¡ç†å™¨
manager = get_task_manager()

# æ¸…ç†æˆåŠŸçš„ä»»åŠ¡
result = manager.clear_tasks(
    user_id=1,
    status_filter=['success']
)

print(f"å·²åˆ é™¤: {result['deleted_count']} ä¸ªä»»åŠ¡")

# æ¸…ç†æŒ‡å®šä»»åŠ¡ID
result = manager.clear_tasks(
    user_id=1,
    task_ids=['uuid-1', 'uuid-2']
)
```

## æ¸…ç†é€»è¾‘

### æ¸…ç†æµç¨‹

1. **æƒé™éªŒè¯**ï¼šéªŒè¯ä»»åŠ¡å±äºå½“å‰ç”¨æˆ·
2. **çŠ¶æ€æ£€æŸ¥**ï¼šæ£€æŸ¥ä»»åŠ¡çŠ¶æ€æ˜¯å¦å…è®¸åˆ é™¤
3. **Redisæ¸…ç†**ï¼šå°è¯•ä»Redisä¸­åˆ é™¤RQä»»åŠ¡è®°å½•
4. **æ•°æ®åº“æ¸…ç†**ï¼šä»æ•°æ®åº“ä¸­åˆ é™¤ä»»åŠ¡è®°å½•
5. **ç»“æœè¿”å›**ï¼šè¿”å›æ¸…ç†ç»Ÿè®¡ä¿¡æ¯

### ä¸å¯åˆ é™¤çš„ä»»åŠ¡çŠ¶æ€

- `pending`ï¼šå¾…å¤„ç†
- `queued`ï¼šå·²å…¥é˜Ÿ
- `running`ï¼šè¿è¡Œä¸­

è¿™äº›çŠ¶æ€çš„ä»»åŠ¡å¿…é¡»å…ˆ**å–æ¶ˆ**åæ‰èƒ½åˆ é™¤ã€‚

### å¯åˆ é™¤çš„ä»»åŠ¡çŠ¶æ€

- `success`ï¼šæˆåŠŸ
- `failed`ï¼šå¤±è´¥
- `cancelled`ï¼šå·²å–æ¶ˆ

## æµ‹è¯•

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
cd D:\work\code\TOP_N
python test_clear_tasks.py
```

### æµ‹è¯•å†…å®¹

1. æŸ¥çœ‹å½“å‰ä»»åŠ¡ç»Ÿè®¡
2. æµ‹è¯•æ¸…ç†æˆåŠŸçš„ä»»åŠ¡
3. æµ‹è¯•æ¸…ç†å¤±è´¥çš„ä»»åŠ¡
4. éªŒè¯æ¸…ç†åçš„ä»»åŠ¡ç»Ÿè®¡
5. æµ‹è¯•æ¸…ç†æŒ‡å®šä»»åŠ¡ID
6. æµ‹è¯•æ¸…ç†æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆåº”è¯¥å¤±è´¥ï¼‰

## æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æç¤º**

1. **ä¸å¯æ’¤é”€**ï¼šåˆ é™¤æ“ä½œæ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œ
2. **å…ˆå–æ¶ˆååˆ é™¤**ï¼šè¿è¡Œä¸­çš„ä»»åŠ¡å¿…é¡»å…ˆå–æ¶ˆæ‰èƒ½åˆ é™¤
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šæ¸…ç†ä¼šåŒæ—¶åˆ é™¤Rediså’Œæ•°æ®åº“ä¸­çš„è®°å½•
4. **æƒé™éš”ç¦»**ï¼šåªèƒ½åˆ é™¤è‡ªå·±çš„ä»»åŠ¡ï¼Œæ— æ³•åˆ é™¤å…¶ä»–ç”¨æˆ·çš„ä»»åŠ¡

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

### åç«¯æ–‡ä»¶

1. `backend/services/task_queue_manager.py`
   - æ–°å¢ `clear_tasks()` æ–¹æ³•

2. `backend/blueprints/task_api.py`
   - æ–°å¢ `/task/clear` API ç«¯ç‚¹

### å‰ç«¯æ–‡ä»¶

1. `static/publish_history.js`
   - æ–°å¢ `clearTasksByStatus()` æ–¹æ³•
   - æ–°å¢ `clearSuccessTasks()` æ–¹æ³•
   - æ–°å¢ `clearFailedTasks()` æ–¹æ³•
   - æ–°å¢ `clearCompletedTasks()` æ–¹æ³•

2. `templates/publish.html`
   - æ–°å¢ä¸‰ä¸ªæ¸…ç†æŒ‰é’®

### æµ‹è¯•æ–‡ä»¶

1. `test_clear_tasks.py`
   - æµ‹è¯•æ¸…ç†åŠŸèƒ½çš„è„šæœ¬

### æ–‡æ¡£æ–‡ä»¶

1. `docs/CLEAR_TASKS_GUIDE.md`
   - æœ¬ä½¿ç”¨æŒ‡å—

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæ— æ³•åˆ é™¤æŸäº›ä»»åŠ¡ï¼Ÿ

A: åªèƒ½åˆ é™¤å·²å®Œæˆçš„ä»»åŠ¡ï¼ˆ`success`ã€`failed`ã€`cancelled`ï¼‰ã€‚å¦‚æœä»»åŠ¡æ­£åœ¨è¿è¡Œï¼ˆ`pending`ã€`queued`ã€`running`ï¼‰ï¼Œéœ€è¦å…ˆé€šè¿‡å–æ¶ˆæ¥å£å–æ¶ˆä»»åŠ¡ã€‚

### Q: åˆ é™¤åèƒ½æ¢å¤å—ï¼Ÿ

A: ä¸èƒ½ã€‚åˆ é™¤æ“ä½œä¼šæ°¸ä¹…åˆ é™¤æ•°æ®åº“å’ŒRedisä¸­çš„ä»»åŠ¡è®°å½•ï¼Œæ— æ³•æ¢å¤ã€‚

### Q: ä¼šå½±å“æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å—ï¼Ÿ

A: ä¸ä¼šã€‚æ¸…ç†åŠŸèƒ½æœ‰ä¸¥æ ¼çš„çŠ¶æ€æ£€æŸ¥ï¼Œä¸ä¼šåˆ é™¤æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚

### Q: æ¸…ç†åä¼šé‡Šæ”¾é™æµä»¤ç‰Œå—ï¼Ÿ

A: æ¸…ç†æ“ä½œä¸ä¼šé‡Šæ”¾é™æµä»¤ç‰Œã€‚é™æµä»¤ç‰Œåªåœ¨å–æ¶ˆä»»åŠ¡æ—¶é‡Šæ”¾ã€‚

## æ›´æ–°æ—¥å¿—

- **2024-01-XX**ï¼šåˆå§‹ç‰ˆæœ¬å‘å¸ƒ
  - æ”¯æŒæŒ‰çŠ¶æ€æ‰¹é‡æ¸…ç†ä»»åŠ¡
  - æ”¯æŒæŒ‰ä»»åŠ¡IDæ¸…ç†ä»»åŠ¡
  - æ·»åŠ å‰ç«¯æ¸…ç†æŒ‰é’®
  - æ·»åŠ å®‰å…¨ä¿æŠ¤æœºåˆ¶
